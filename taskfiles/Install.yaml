version: "3"

# Install Tasks - Taskfile Module
# Included from main Taskfile.yaml

tasks:
  # =============================================================================
  # ESO INSTALLATION
  # =============================================================================

  live:
    desc: Install addon to ESO Live client (copy)
    cmds:
      - |
        echo "üì• Installing {{.ADDON_NAME}} to ESO Live..."

        if git describe --tags --exact-match HEAD >/dev/null 2>&1; then
          VERSION=$(git describe --tags --exact-match HEAD | sed 's/^v//')
        elif git describe --tags >/dev/null 2>&1; then
          VERSION=$(git describe --tags | sed 's/^v//')
        else
          VERSION=$(git rev-parse --short HEAD)
        fi
        echo "   Using version: ${VERSION}"

        mkdir -p "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}/{{.SRC_DIR}}"

        cp {{.MANIFEST_FILE}} "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}/"

        if [ -d "assets" ]; then
          cp -r assets/ "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}/assets/"
          echo "  ‚úì Copied assets/"
        fi

        cp -r {{.SRC_DIR}}/ "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}/{{.SRC_DIR}}"
        echo "  ‚úì Copied {{.SRC_DIR}}/"

        [ -f "README.md" ] && cp README.md "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}/" && echo "  ‚úì Copied README.md"
        [ -f "LICENSE" ] && cp LICENSE "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}/" && echo "  ‚úì Copied LICENSE"

        echo "üîÑ Injecting version ${VERSION}..."
        ./scripts/replace-version.sh "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}" "$VERSION"

        echo "‚úÖ Installed to {{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}"
    silent: true

  pts:
    desc: Install addon to ESO PTS client (copy)
    cmds:
      - |
        echo "üì• Installing {{.ADDON_NAME}} to ESO PTS..."
        mkdir -p "{{.ESO_PTS_ADDONS}}/{{.ADDON_NAME}}/{{.SRC_DIR}}"

        cp {{.MANIFEST_FILE}} "{{.ESO_PTS_ADDONS}}/{{.ADDON_NAME}}/"
        cp -r {{.SRC_DIR}}/ "{{.ESO_PTS_ADDONS}}/{{.ADDON_NAME}}/{{.SRC_DIR}}"

        echo "‚úÖ Installed to {{.ESO_PTS_ADDONS}}/{{.ADDON_NAME}}"
    silent: true

  dev:
    desc: Create symlink for development (changes apply immediately)
    cmds:
      - |
        echo "üîó Creating development symlink..."

        if [ -L "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}" ]; then
          echo "  ‚úì Symlink already exists"
        elif [ -d "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}" ]; then
          echo "  ‚ö†Ô∏è  Directory exists. Remove first: rm -rf '{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}'"
          exit 1
        else
          ln -s "$(pwd)" "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}"
          echo "  ‚úì Symlink created"
        fi

        echo "‚úÖ Development mode active (symlink to $(pwd))"
    silent: true

  uninstall:
    desc: Remove addon from ESO
    cmds:
      - |
        echo "üóëÔ∏è  Removing {{.ADDON_NAME}} from ESO..."

        if [ -L "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}" ]; then
          rm "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}"
          echo "  ‚úì Removed symlink"
        elif [ -d "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}" ]; then
          rm -rf "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}"
          echo "  ‚úì Removed directory"
        else
          echo "  ‚ÑπÔ∏è  Addon not installed"
        fi

        echo "‚úÖ Uninstall complete"
    silent: true

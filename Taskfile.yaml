version: '3'

# CharacterMarkdown - Developer Task Automation
# Requires: Task (https://taskfile.dev)
# Install: brew install go-task/tap/go-task

vars:
  ADDON_NAME: CharacterMarkdown
  # Updated: Use .addon manifest (Console-compatible format)
  MANIFEST_FILE: CharacterMarkdown.addon
  VERSION:
    sh: grep "## Version:" {{.MANIFEST_FILE}} | awk '{print $3}'
  # Directories
  ESO_LIVE_ADDONS: "{{.HOME}}/Documents/Elder Scrolls Online/live/AddOns"
  ESO_PTS_ADDONS: "{{.HOME}}/Documents/Elder Scrolls Online/pts/AddOns"
  ESO_LIVE_SAVEDVARS: "{{.HOME}}/Documents/Elder Scrolls Online/live/SavedVariables"
  BUILD_DIR: build
  DIST_DIR: dist
  SRC_DIR: src
  
  # Required files
  REQUIRED_FILES: "{{.MANIFEST_FILE}} README.md LICENSE"

tasks:
  # =============================================================================
  # DEFAULT TASK
  # =============================================================================
  
  default:
    desc: Show available tasks
    cmds:
      - task --list-all
    silent: true

  # =============================================================================
  # SETUP & DEPENDENCIES
  # =============================================================================
  
  setup:deps:
    desc: Install development dependencies (LuaJIT, Luacheck, StyLua, pre-commit)
    cmds:
      - echo "ğŸ“¦ Installing development dependencies..."
      - brew list luajit &>/dev/null || brew install luajit
      - brew list luarocks &>/dev/null || brew install luarocks
      - luarocks list luacheck | grep -q luacheck || luarocks install luacheck
      - brew list stylua &>/dev/null || brew install stylua
      - command -v pre-commit &>/dev/null || brew install pre-commit
      - pre-commit install
      - echo "âœ… Dependencies installed successfully"
      - echo ""
      - echo "Installed:"
      - luajit -v
      - luacheck --version
      - stylua --version
      - pre-commit --version
    silent: true

  # =============================================================================
  # DEVELOPMENT WORKFLOW
  # =============================================================================
  
  dev:start:
    desc: Start development mode (symlink + watch)
    cmds:
      - task: install:dev
      - echo ""
      - echo "ğŸ”¥ Development mode active!"
      - echo "  - Edit files in this directory"
      - echo "  - Use /reloadui in ESO to test changes"
      - echo "  - Press Ctrl+C to stop watching"
      - echo ""
      - task: dev:watch
    silent: true

  dev:watch:
    desc: Watch for file changes (requires fswatch)
    cmds:
      - |
        if ! command -v fswatch &> /dev/null; then
          echo "âš ï¸  fswatch not installed. Install with: brew install fswatch"
          exit 1
        fi
        echo "ğŸ‘€ Watching for changes..."
        fswatch -o {{.SRC_DIR}}/ | while read; do
          echo "[$(date +%H:%M:%S)] Files changed - use /reloadui in ESO"
        done
    silent: true

  dev:lint:
    desc: Run Luacheck on all Lua files
    cmds:
      - |
        echo "ğŸ” Running Luacheck..."
        luacheck {{.SRC_DIR}} --exclude-files "*.backup" --exclude-files ".task/**" --ignore 212 || true
      - echo "âœ… Lint passed"
    silent: true

  dev:lint:fix:
    desc: Auto-fix Luacheck issues where possible
    cmds:
      - |
        echo "ğŸ”§ Auto-fixing Luacheck issues..."
        luacheck {{.SRC_DIR}} --exclude-files "*.backup" --exclude-files ".task/**" --ignore 212 --fix || true
      - echo "âœ… Auto-fix complete"
    silent: true

  dev:format:
    desc: Format Lua code with StyLua
    cmds:
      - |
        echo "âœ¨ Formatting Lua code with StyLua..."
        if command -v stylua &>/dev/null; then
          stylua --config-path .stylua.toml {{.SRC_DIR}}
          echo "âœ… Code formatted successfully"
        else
          echo "âŒ StyLua not found. Install with: cargo install stylua"
          echo "   Or: brew install stylua"
          exit 1
        fi
    silent: true

  dev:format:check:
    desc: Check if Lua code is formatted correctly (without modifying)
    cmds:
      - |
        echo "ğŸ” Checking Lua code formatting..."
        if command -v stylua &>/dev/null; then
          stylua --config-path .stylua.toml --check {{.SRC_DIR}}
          echo "âœ… Code formatting is correct"
        else
          echo "âŒ StyLua not found. Install with: cargo install stylua"
          echo "   Or: brew install stylua"
          exit 1
        fi
    silent: true

  dev:validate:
    desc: Validate addon manifest and project structure
    cmds:
      - echo "âœ… Validating project..."
      - task: dev:validate:files
      - task: dev:validate:manifest
      - task: dev:validate:syntax
      - echo "âœ… All validations passed"
    silent: true

  dev:validate:changelog:
    desc: Validate CHANGELOG.md has version entries
    cmds:
      - echo "  Checking CHANGELOG.md..."
      - |
        if [ ! -f "CHANGELOG.md" ]; then
          echo "  âœ— CHANGELOG.md not found"
          exit 1
        fi
        if ! grep -q "^## \[.*\]" CHANGELOG.md; then
          echo "  âœ— CHANGELOG.md has no version entries"
          exit 1
        fi
        if grep -q "^## \[Unreleased\]" CHANGELOG.md; then
          echo "    âš ï¸  CHANGELOG.md has [Unreleased] section"
        fi
        echo "    âœ“ CHANGELOG.md is valid"
    silent: true

  dev:validate:readme:
    desc: Validate README.md version badges match manifest
    cmds:
      - echo "  Checking README.md badges..."
      - |
        if [ ! -f "README.md" ]; then
          echo "  âœ— README.md not found"
          exit 1
        fi
        
        # Get API version from manifest
        MANIFEST_API=$(grep "^## APIVersion:" {{.MANIFEST_FILE}} | awk '{print $3}')
        
        # Check if README has API badge
        if grep -q "badge/ESO_API-${MANIFEST_API}-" README.md; then
          echo "    âœ“ API version badge matches manifest (${MANIFEST_API})"
        else
          echo "    âš ï¸  API version badge may not match manifest"
          echo "       Manifest API: ${MANIFEST_API}"
          echo "       Check: https://img.shields.io/badge/ESO_API-${MANIFEST_API}-green.svg"
        fi
        
        # Note about version badge (uses @project-version@ placeholder)
        if grep -q "@project-version@" {{.MANIFEST_FILE}}; then
          echo "    â„¹ï¸  Version badge should be updated after tagging (Git-based versioning)"
        fi
        
        echo "    âœ“ README.md validation complete"
    silent: true

  dev:validate:all:
    desc: Run all validation checks (files, manifest, syntax, changelog, readme)
    deps: [dev:validate, dev:validate:changelog, dev:validate:readme]
    cmds:
      - echo "âœ… All validations passed"
    silent: true

  dev:validate:files:
    desc: Check that all required files exist
    cmds:
      - echo "  Checking required files..."
      - |
        for file in {{.MANIFEST_FILE}} README.md LICENSE; do
          if [ ! -f "$file" ]; then
            echo "  âœ— Missing required file: $file"
            exit 1
          fi
        done
        if [ ! -d "{{.SRC_DIR}}" ]; then
          echo "  âœ— Missing required directory: {{.SRC_DIR}}"
          exit 1
        fi
      - echo "    âœ“ All required files present"
    silent: true

  dev:validate:manifest:
    desc: Validate addon manifest file
    cmds:
      - echo "  Validating manifest..."
      - |
        # Basic validation - check required fields
        if ! grep -q "^## Title:" {{.MANIFEST_FILE}}; then
          echo "  âœ— Missing Title in manifest"
          exit 1
        fi
        if ! grep -q "^## Version:" {{.MANIFEST_FILE}}; then
          echo "  âœ— Missing Version in manifest"
          exit 1
        fi
        if ! grep -q "^## APIVersion:" {{.MANIFEST_FILE}}; then
          echo "  âœ— Missing APIVersion in manifest"
          exit 1
        fi
        echo "    âœ“ Manifest valid"
    silent: true

  dev:validate:syntax:
    desc: Check Lua syntax with LuaJIT
    cmds:
      - echo "  Checking Lua syntax..."
      - |
        find {{.SRC_DIR}} -name "*.lua" -type f | while read file; do
          luajit -bl "$file" > /dev/null || (echo "  âœ— Lua syntax errors in $file" && exit 1)
        done
      - echo "    âœ“ All Lua files syntax valid"
    silent: true

  dev:test:
    desc: Run all tests (lint + validate)
    deps: [dev:lint, dev:validate]
    cmds:
      - echo "âœ… All tests passed"
    silent: true

  dev:backup:
    desc: Create backup of current addon
    cmds:
      - |
        BACKUP_NAME="backup-{{.ADDON_NAME}}-$(date +%Y%m%d-%H%M%S).tar.gz"
        echo "ğŸ’¾ Creating backup: $BACKUP_NAME"
        tar czf "$BACKUP_NAME" {{.MANIFEST_FILE}} README.md LICENSE {{.SRC_DIR}}/
        echo "âœ… Backup created: $BACKUP_NAME"
    silent: true

  # =============================================================================
  # BUILD & PACKAGE
  # =============================================================================

  build:clean:
    desc: Clean build artifacts
    cmds:
      - |
        echo "ğŸ§¹ Cleaning build artifacts..."
        rm -rf {{.BUILD_DIR}}
        rm -rf {{.DIST_DIR}}
        rm -f {{.ADDON_NAME}}-*.zip
        echo "âœ… Clean complete"
    silent: true

  build:release:
    desc: Build release ZIP artifact with full validation
    deps: [build:clean, dev:test]
    cmds:
      - |
        echo "ğŸ“¦ Building {{.ADDON_NAME}} release..."
        
        # Get version from Git (tag or commit SHA)
        if git describe --tags --exact-match HEAD >/dev/null 2>&1; then
          # On a tag
          VERSION=$(git describe --tags --exact-match HEAD | sed 's/^v//')
          echo "   Using tag version: ${VERSION}"
        else
          # Use commit SHA (matches ESOUI behavior)
          VERSION=$(git rev-parse --short HEAD)
          echo "   Using commit SHA: ${VERSION}"
        fi
        
        mkdir -p {{.BUILD_DIR}}/{{.ADDON_NAME}}
        mkdir -p {{.DIST_DIR}}
        
        # Copy files using .build-ignore exclusions
        rsync -a --quiet \
          --exclude-from=.build-ignore \
          --exclude='{{.BUILD_DIR}}' \
          --exclude='{{.DIST_DIR}}' \
          . {{.BUILD_DIR}}/{{.ADDON_NAME}}/
      - |
        # Get version again for replacement
        if git describe --tags --exact-match HEAD >/dev/null 2>&1; then
          VERSION=$(git describe --tags --exact-match HEAD | sed 's/^v//')
        else
          VERSION=$(git rev-parse --short HEAD)
        fi
        
        # Replace @project-version@ placeholders in all files (manifest, source, docs, etc.)
        ./scripts/replace-version.sh "{{.BUILD_DIR}}/{{.ADDON_NAME}}" "$VERSION"
        
        # Create ZIP with version
        cd {{.BUILD_DIR}} && zip -r -q "../{{.DIST_DIR}}/{{.ADDON_NAME}}-${VERSION}.zip" {{.ADDON_NAME}}
        echo "âœ… Built: {{.DIST_DIR}}/{{.ADDON_NAME}}-${VERSION}.zip"
      - |
        # Get version for validation
        if git describe --tags --exact-match HEAD >/dev/null 2>&1; then
          VERSION=$(git describe --tags --exact-match HEAD | sed 's/^v//')
        else
          VERSION=$(git rev-parse --short HEAD)
        fi
        
        # Run comprehensive ZIP validation
        chmod +x scripts/validate-zip.sh
        scripts/validate-zip.sh "{{.DIST_DIR}}/{{.ADDON_NAME}}-${VERSION}.zip"

  build:fast:
    desc: Build without tests (fast local iteration)
    deps: [build:clean]
    cmds:
      - |
        echo "ğŸ“¦ Building {{.ADDON_NAME}} (fast mode)..."
        
        # Get version from Git (tag or commit SHA)
        if git describe --tags --exact-match HEAD >/dev/null 2>&1; then
          VERSION=$(git describe --tags --exact-match HEAD | sed 's/^v//')
          echo "   Using tag version: ${VERSION}"
        else
          VERSION=$(git rev-parse --short HEAD)
          echo "   Using commit SHA: ${VERSION}"
        fi
        
        mkdir -p {{.BUILD_DIR}}/{{.ADDON_NAME}}
        mkdir -p {{.DIST_DIR}}
        rsync -a --quiet \
          --exclude-from=.build-ignore \
          --exclude='{{.BUILD_DIR}}' \
          --exclude='{{.DIST_DIR}}' \
          . {{.BUILD_DIR}}/{{.ADDON_NAME}}/
      - |
        # Get version again for replacement
        if git describe --tags --exact-match HEAD >/dev/null 2>&1; then
          VERSION=$(git describe --tags --exact-match HEAD | sed 's/^v//')
        else
          VERSION=$(git rev-parse --short HEAD)
        fi
        
        # Replace @project-version@ placeholders in all files
        ./scripts/replace-version.sh "{{.BUILD_DIR}}/{{.ADDON_NAME}}" "$VERSION"
        
        cd {{.BUILD_DIR}} && zip -r -q "../{{.DIST_DIR}}/{{.ADDON_NAME}}-${VERSION}.zip" {{.ADDON_NAME}}
        echo "âœ… Built: {{.DIST_DIR}}/{{.ADDON_NAME}}-${VERSION}.zip"

  build:esoui:
    desc: Create ESOUI-compatible package (same as build:release)
    deps: [build:release]
    cmds:
      - |
        echo "âœ… ESOUI package ready: {{.DIST_DIR}}/{{.ADDON_NAME}}-{{.VERSION}}.zip"
    silent: true

  build:verify:
    desc: Verify package meets ESOUI requirements
    cmds:
      - echo "âœ… Verifying ESOUI package requirements..."
      - |
        if [ ! -f "{{.DIST_DIR}}/{{.ADDON_NAME}}-{{.VERSION}}.zip" ]; then
          echo "âŒ Package not found. Run: task build:release"
          exit 1
        fi
      - echo "  âœ“ Package exists"
      - |
        SIZE=$(stat -f%z "{{.DIST_DIR}}/{{.ADDON_NAME}}-{{.VERSION}}.zip" 2>/dev/null || stat -c%s "{{.DIST_DIR}}/{{.ADDON_NAME}}-{{.VERSION}}.zip")
        SIZE_MB=$((SIZE / 1024 / 1024))
        if [ $SIZE_MB -gt 10 ]; then
          echo "  âš ï¸  Warning: Package >10MB (${SIZE_MB}MB)"
        else
          echo "  âœ“ Package size OK (${SIZE_MB}MB)"
        fi
      - echo "  âœ“ Ready for ESOUI/Minion upload"
    silent: true

  # =============================================================================
  # VERSION MANAGEMENT
  # =============================================================================

  version:show:
    desc: Show current version info (Git tag/commit based)
    cmds:
      - |
        echo "ğŸ“¦ {{.ADDON_NAME}}"
        
        # Show Git version info (tag or commit)
        if git describe --tags --exact-match HEAD >/dev/null 2>&1; then
          VERSION=$(git describe --tags --exact-match HEAD | sed 's/^v//')
          echo "   Version (Tag): ${VERSION}"
        else
          VERSION=$(git rev-parse --short HEAD)
          echo "   Version (Commit): ${VERSION}"
        fi
        
        # Show API version from manifest
        if grep -q "^## APIVersion:" {{.MANIFEST_FILE}}; then
          API_VERSION=$(grep "^## APIVersion:" {{.MANIFEST_FILE}} | awk '{print $3}')
          echo "   API Version: ${API_VERSION}"
        fi
        
        # Show manifest placeholder status
        if grep -q "@project-version@" {{.MANIFEST_FILE}}; then
          echo "   Manifest: Using @project-version@ placeholder (Git-based)"
        fi
    silent: true

  version:api:
    desc: "Update ESO API version (usage: task version:api -- <API_VERSION>)"
    vars:
      API_VERSION: '{{.CLI_ARGS | default ""}}'
    cmds:
      - |
        if [ -z "{{.API_VERSION}}" ]; then
          echo "âŒ Error: API version required"
          echo ""
          echo "Usage: task version:api -- <API_VERSION>"
          echo ""
          echo "To get current API version:"
          echo "  1. Launch ESO"
          echo "  2. Type in chat: /script d(GetAPIVersion())"
          echo "  3. Run: task version:api -- <VERSION>"
          echo ""
          echo "Example:"
          echo "  task version:api -- 101047"
          exit 1
        fi
      - |
        echo "ğŸ”„ Updating API version to: {{.API_VERSION}}"
        chmod +x scripts/update-api-version.sh
        ./scripts/update-api-version.sh "{{.API_VERSION}}"
    silent: true

  version:bump:
    desc: "Bump version number (usage: task version:bump -- <major|minor|patch>)"
    vars:
      BUMP_TYPE: '{{.CLI_ARGS | default "patch"}}'
    cmds:
      - |
        echo "ğŸ”„ Bumping {{.BUMP_TYPE}} version..."
        CURRENT="{{.VERSION}}"
        IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

        case "{{.BUMP_TYPE}}" in
          major)
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
            ;;
          minor)
            MINOR=$((MINOR + 1))
            PATCH=0
            ;;
          patch|*)
            PATCH=$((PATCH + 1))
            ;;
        esac

        NEW_VERSION="$MAJOR.$MINOR.$PATCH"
        echo "  $CURRENT â†’ $NEW_VERSION"

        # Note: Manifest uses @project-version@, so no need to update it
        echo "   (Manifest uses @project-version@ placeholder - Git-based versioning)"

        # Update CHANGELOG
        DATE=$(date +%Y-%m-%d)
        if [[ "$OSTYPE" == "darwin"* ]]; then
          sed -i '' "s/## \[Unreleased\]/## [Unreleased]\n\n## [$NEW_VERSION] - $DATE/" CHANGELOG.md
        else
          sed -i "s/## \[Unreleased\]/## [Unreleased]\n\n## [$NEW_VERSION] - $DATE/" CHANGELOG.md
        fi

        echo "âœ… Version bumped to $NEW_VERSION"
        echo "âœ… CHANGELOG.md updated"
        echo ""
        echo "Next steps:"
        echo "  1. Review CHANGELOG.md changes"
        echo "  2. Commit changes: git commit -am 'Release v$NEW_VERSION'"
        echo "  3. Create tag: git tag -a v$NEW_VERSION -m 'Release v$NEW_VERSION'"
        echo "  4. Push tag: git push origin main --tags"
        echo ""
        echo "Note: Manifest uses @project-version@ (Git-based versioning)"
        echo "      Version is automatically set from Git tags during build."
    silent: true

  # =============================================================================
  # RELEASE WORKFLOW
  # =============================================================================

  release:check:
    desc: Run comprehensive pre-release validation (recommended before every release)
    cmds:
      - |
        echo "ğŸš€ Running comprehensive pre-release validation..."
        echo "   (This runs all checks from RELEASE_CHECKLIST.md)"
        echo ""
        if [ -f "scripts/pre-release-check.sh" ]; then
          chmod +x scripts/pre-release-check.sh
          ./scripts/pre-release-check.sh
        else
          echo "âŒ scripts/pre-release-check.sh not found"
          exit 1
        fi
    silent: true

  release:checklist:
    desc: Display interactive release checklist
    cmds:
      - |
        echo "ğŸ“‹ CharacterMarkdown - Release Checklist"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "Use this checklist before every release:"
        echo ""
        echo "1. CODE QUALITY & VALIDATION"
        echo "   task release:check              - Run all automated checks"
        echo "   task lint                       - Luacheck validation"
        echo "   task validate:syntax            - Lua syntax check"
        echo "   task validate:manifest          - Manifest validation"
        echo "   task validate:files             - File structure check"
        echo ""
        echo "2. VERSION MANAGEMENT"
        echo "   task version:bump -- patch      - Bump version (patch/minor/major)"
        echo "   task version                    - Show current version"
        echo "   task version:api -- <VERSION>   - Update ESO API version"
        echo ""
        echo "3. DOCUMENTATION"
        echo "   - Update CHANGELOG.md with release notes"
        echo "   - Review README.md for accuracy"
        echo "   - Check docs/ for updates"
        echo ""
        echo "4. BUILD & PACKAGE"
        echo "   task build                      - Build release ZIP"
        echo "   task build:verify               - Verify package requirements"
        echo ""
        echo "5. GIT & RELEASE"
        echo "   task release:workflow           - Interactive release workflow"
        echo "   task release:tag                - Create and push tag"
        echo ""
        echo "6. POST-RELEASE"
        echo "   - Monitor GitHub Actions for automated release"
        echo "   - Verify ESOUI upload (if configured)"
        echo "   - Test downloaded ZIP from GitHub"
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "For full checklist: cat RELEASE_CHECKLIST.md"
        echo "For automated validation: task release:check"
    silent: true

  release:workflow:
    desc: Interactive release workflow (guides through all steps)
    cmds:
      - |
        echo "ğŸš€ CharacterMarkdown - Release Workflow"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        
        # Show current version
        if git describe --tags --exact-match HEAD >/dev/null 2>&1; then
          CURRENT_VERSION=$(git describe --tags --exact-match HEAD | sed 's/^v//')
        else
          CURRENT_VERSION=$(git rev-parse --short HEAD)
        fi
        echo "Current version: ${CURRENT_VERSION}"
        echo ""
        
        # Step 1: Version bump
        echo "STEP 1: Version Bump"
        echo "  What type of release is this?"
        read -p "  Enter bump type (patch/minor/major) [patch]: " BUMP_TYPE
        BUMP_TYPE=${BUMP_TYPE:-patch}
        echo "  Running: task version:bump -- ${BUMP_TYPE}"
        task version:bump -- ${BUMP_TYPE}
        echo ""
        
        # Step 2: CHANGELOG update reminder
        echo "STEP 2: Update CHANGELOG.md"
        echo "  âš ï¸  Please update CHANGELOG.md with release notes now"
        read -p "  Press Enter when done..."
        echo ""
        
        # Step 3: Run validation
        echo "STEP 3: Run Pre-Release Validation"
        read -p "  Run comprehensive validation? (Y/n): " RUN_VALIDATION
        if [ "$RUN_VALIDATION" != "n" ] && [ "$RUN_VALIDATION" != "N" ]; then
          task release:check
        fi
        echo ""
        
        # Step 4: Commit changes
        echo "STEP 4: Commit Changes"
        if git describe --tags --exact-match HEAD >/dev/null 2>&1; then
          NEW_VERSION=$(git describe --tags --exact-match HEAD | sed 's/^v//')
        else
          # Get version from manifest
          NEW_VERSION=$(grep "## Version:" CharacterMarkdown.addon | awk '{print $3}')
        fi
        read -p "  Commit message [Release v${NEW_VERSION}]: " COMMIT_MSG
        COMMIT_MSG=${COMMIT_MSG:-"Release v${NEW_VERSION}"}
        git add .
        git commit -m "${COMMIT_MSG}"
        echo "  âœ… Changes committed"
        echo ""
        
        # Step 5: Create and push tag
        echo "STEP 5: Create and Push Tag"
        task release:tag
    silent: true

  release:prepare:
    desc: Prepare for release (validate and show next steps)
    cmds:
      - echo "ğŸš€ Preparing release..."
      - echo "âš ï¸  Ensure CHANGELOG.md is updated with release notes"
      - echo "âš ï¸  Ensure version in {{.MANIFEST_FILE}} is correct"
      - task: dev:test
      - |
        VERSION="{{.VERSION}}"
        echo ""
        echo "ğŸ“‹ Release Checklist:"
        echo "  1. âœ… Tests passed"
        echo "  2. Update CHANGELOG.md with version ${VERSION}"
        echo "  3. Commit changes: git commit -am 'Release v${VERSION}'"
        echo "  4. Create tag: git tag v${VERSION}"
        echo "  5. Push: git push origin main --tags"
        echo ""
        echo "GitHub Actions will automatically:"
        echo "  - Build release ZIP"
        echo "  - Create GitHub release"
        echo "  - Upload to ESOUI (if configured)"
        echo ""
        echo "Tip: Use 'task release:workflow' for guided release process"
    silent: true

  release:tag:
    desc: "Create and push release tag (interactive) - Usage: task release:tag -- 2.2.0"
    cmds:
      - |
        # Check if version provided as CLI argument
        if [ -n "{{.CLI_ARGS}}" ]; then
          VERSION="{{.CLI_ARGS}}"
        else
          VERSION="{{.VERSION}}"
        fi
        
        # Validate semantic version format (X.Y.Z)
        if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
          echo "âŒ Error: Version must be in semantic format (e.g., 2.2.0)"
          echo "   Provided: $VERSION"
          exit 1
        fi
        
        echo "ğŸ“‹ Creating release tag v${VERSION}"
        read -p "Create tag v${VERSION}? (y/N): " CONFIRM
        if [ "$CONFIRM" = "y" ] || [ "$CONFIRM" = "Y" ]; then
          git tag -a "v${VERSION}" -m "Release v${VERSION}"
          echo "âœ… Tag created: v${VERSION}"
          echo ""
          read -p "Push tag to origin? (y/N): " PUSH
          if [ "$PUSH" = "y" ] || [ "$PUSH" = "Y" ]; then
            git push origin main --tags
            echo "âœ… Tag pushed to GitHub"
            echo "ğŸš€ GitHub Actions will now build and release"
          else
            echo "âš ï¸  Tag created locally but not pushed"
            echo "   Push with: git push origin main --tags"
          fi
        else
          echo "âŒ Tag creation cancelled"
        fi
    silent: true

  release:full:
    desc: Create full release (build, package, tag) - backward compatibility
    deps: [dev:validate]
    cmds:
      - task: build:release
      - task: git:tag
      - |
        echo ""
        echo "âœ… Release v{{.VERSION}} ready!"
        echo ""
        echo "Next steps:"
        echo "  1. Push tag: git push origin main --tags"
        echo "  2. Upload: {{.DIST_DIR}}/{{.ADDON_NAME}}-v{{.VERSION}}.zip"
        echo "  3. GitHub Actions will handle the rest"
    silent: true

  release:github:
    desc: Create GitHub release (requires gh CLI)
    deps: [build:release]
    cmds:
      - |
        echo "ğŸš€ Creating GitHub release v{{.VERSION}}..."
        gh release create "v{{.VERSION}}" "{{.DIST_DIR}}/{{.ADDON_NAME}}-{{.VERSION}}.zip" \
          --title "v{{.VERSION}}" \
          --notes-file CHANGELOG.md
        echo "âœ… GitHub release created"
    silent: true

  # =============================================================================
  # ESO INSTALLATION
  # =============================================================================
  
  install:live:
    desc: Install addon to ESO Live client (copy)
    cmds:
      - |
        echo "ğŸ“¥ Installing {{.ADDON_NAME}} to ESO Live..."
        mkdir -p "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}/{{.SRC_DIR}}"
        
        # Copy manifest (.addon format)
        cp {{.MANIFEST_FILE}} "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}/"
        
        # Copy assets directory if exists
        if [ -d "assets" ]; then
          cp -r assets/ "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}/assets/"
          echo "  âœ“ Copied assets/"
        fi
        
        # Copy source files
        cp -r {{.SRC_DIR}}/ "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}/{{.SRC_DIR}}"
        echo "  âœ“ Copied {{.SRC_DIR}}/"
        
        # Copy optional documentation files
        if [ -f "README.md" ]; then
          cp README.md "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}/"
          echo "  âœ“ Copied README.md"
        fi
        
        if [ -f "LICENSE" ]; then
          cp LICENSE "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}/"
          echo "  âœ“ Copied LICENSE"
        fi
        
        echo "âœ… Installed to {{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}"
    silent: true

  install:pts:
    desc: Install addon to ESO PTS client (copy)
    cmds:
      - |
        echo "ğŸ“¥ Installing {{.ADDON_NAME}} to ESO PTS..."
        mkdir -p "{{.ESO_PTS_ADDONS}}/{{.ADDON_NAME}}/{{.SRC_DIR}}"
        
        # Copy manifest
        cp {{.MANIFEST_FILE}} "{{.ESO_PTS_ADDONS}}/{{.ADDON_NAME}}/"
        
        # Copy assets directory if exists
        if [ -d "assets" ]; then
          cp -r assets/ "{{.ESO_PTS_ADDONS}}/{{.ADDON_NAME}}/assets/"
          echo "  âœ“ Copied assets/"
        fi
        
        # Copy settings directory if exists
        if [ -d "settings" ]; then
          cp -r settings/ "{{.ESO_PTS_ADDONS}}/{{.ADDON_NAME}}/settings/"
          echo "  âœ“ Copied settings/"
        fi
        
        # Copy source files
        cp -r {{.SRC_DIR}}/ "{{.ESO_PTS_ADDONS}}/{{.ADDON_NAME}}/{{.SRC_DIR}}"
        echo "  âœ“ Copied {{.SRC_DIR}}/"
        
        # Copy optional documentation files
        if [ -f "README.md" ]; then
          cp README.md "{{.ESO_PTS_ADDONS}}/{{.ADDON_NAME}}/"
          echo "  âœ“ Copied README.md"
        fi
        
        if [ -f "LICENSE" ]; then
          cp LICENSE "{{.ESO_PTS_ADDONS}}/{{.ADDON_NAME}}/"
          echo "  âœ“ Copied LICENSE"
        fi
        
        echo "âœ… Installed to {{.ESO_PTS_ADDONS}}/{{.ADDON_NAME}}"
    silent: true

  install:dev:
    desc: Install addon as symlink for live development
    cmds:
      - |
        echo "ğŸ”— Creating development symlink..."
        rm -rf "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}"
        ln -s "{{.PWD}}" "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}"
        echo "âœ… Development symlink created"
        echo "   Edit files here, use /reloadui in-game to test"
    silent: true

  install:built:
    desc: Install built/validated files to ESO Live client
    deps: [build:release]
    cmds:
      - |
        echo "ğŸ“¦ Installing built {{.ADDON_NAME}} to ESO Live..."
        rm -rf "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}"
        cp -r "{{.BUILD_DIR}}/{{.ADDON_NAME}}" "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}"
        echo "âœ… Built addon installed to {{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}"
        echo "   Files validated and ready for testing"
    silent: true

  install:built:pts:
    desc: Install built/validated files to ESO PTS client
    deps: [build:release]
    cmds:
      - |
        echo "ğŸ“¦ Installing built {{.ADDON_NAME}} to ESO PTS..."
        rm -rf "{{.ESO_PTS_ADDONS}}/{{.ADDON_NAME}}"
        cp -r "{{.BUILD_DIR}}/{{.ADDON_NAME}}" "{{.ESO_PTS_ADDONS}}/{{.ADDON_NAME}}"
        echo "âœ… Built addon installed to {{.ESO_PTS_ADDONS}}/{{.ADDON_NAME}}"
        echo "   Files validated and ready for testing"
    silent: true

  install:uninstall:live:
    desc: Remove addon from ESO Live client
    cmds:
      - |
        echo "ğŸ—‘ï¸  Removing {{.ADDON_NAME}} from ESO Live..."
        rm -rf "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}"
        echo "âœ… Uninstalled from Live"
    silent: true

  install:uninstall:pts:
    desc: Remove addon from ESO PTS client
    cmds:
      - |
        echo "ğŸ—‘ï¸  Removing {{.ADDON_NAME}} from ESO PTS..."
        rm -rf "{{.ESO_PTS_ADDONS}}/{{.ADDON_NAME}}"
        echo "âœ… Uninstalled from PTS"
    silent: true

  install:uninstall:dev:
    desc: Remove development symlink and install normally
    cmds:
      - |
        echo "ğŸ—‘ï¸  Removing development symlink..."
        rm -rf "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}"
        echo "âœ… Symlink removed"
        echo ""
      - task: install:live
    silent: true

  install:clean:savedvars:
    desc: Remove saved variables file for clean reinstall
    cmds:
      - |
        echo "ğŸ—‘ï¸  Removing saved variables..."
        if [ -f "{{.ESO_LIVE_SAVEDVARS}}/{{.ADDON_NAME}}.lua" ]; then
          rm -f "{{.ESO_LIVE_SAVEDVARS}}/{{.ADDON_NAME}}.lua"
          echo "âœ… Saved variables removed"
        else
          echo "â„¹ï¸  No saved variables file found"
        fi
    silent: true

  # =============================================================================
  # GIT OPERATIONS
  # =============================================================================

  git:hooks:install:
    desc: Install git hooks (pre-commit trim + pre-push validation)
    cmds:
      - |
        echo "ğŸ”§ Installing git hooks..."
        
        # Create .git/hooks directory if it doesn't exist
        mkdir -p .git/hooks
        
        # Install pre-commit hook (examples:trim)
        if [ -f "scripts/git-hooks/pre-commit" ]; then
          cp scripts/git-hooks/pre-commit .git/hooks/pre-commit
          chmod +x .git/hooks/pre-commit
          echo "âœ… Pre-commit hook installed"
          echo "   This hook will trim example files before commit"
          echo "   To bypass: git commit --no-verify"
        else
          echo "âš ï¸  scripts/git-hooks/pre-commit not found"
        fi
        
        # Install pre-push hook (validation)
        if [ -f "scripts/git-hooks/pre-push" ]; then
          cp scripts/git-hooks/pre-push .git/hooks/pre-push
          chmod +x .git/hooks/pre-push
          echo "âœ… Pre-push hook installed"
          echo "   This hook will run validation before pushing tags"
          echo "   To bypass: git push --no-verify"
        else
          echo "âŒ scripts/git-hooks/pre-push not found"
          exit 1
        fi
    silent: true

  git:hooks:uninstall:
    desc: Remove git hooks
    cmds:
      - |
        echo "ğŸ—‘ï¸  Removing git hooks..."
        REMOVED=0
        
        if [ -f ".git/hooks/pre-commit" ]; then
          rm .git/hooks/pre-commit
          echo "âœ… Pre-commit hook removed"
          REMOVED=1
        fi
        
        if [ -f ".git/hooks/pre-push" ]; then
          rm .git/hooks/pre-push
          echo "âœ… Pre-push hook removed"
          REMOVED=1
        fi
        
        if [ $REMOVED -eq 0 ]; then
          echo "â„¹ï¸  No git hooks found"
        fi
    silent: true

  git:hooks:test:
    desc: Test pre-push hook (dry run)
    cmds:
      - |
        echo "ğŸ§ª Testing pre-push hook..."
        if [ -f ".git/hooks/pre-push" ]; then
          .git/hooks/pre-push origin main
        else
          echo "âŒ Pre-push hook not installed. Run: task git:hooks:install"
          exit 1
        fi
    silent: true

  git:status:
    desc: Show git status and pending changes
    cmds:
      - git status
      - echo ""
      - echo "Uncommitted changes:"
      - git diff --stat
    silent: true

  git:commit:
    desc: "Stage and commit changes (usage: task git:commit -- \"message\")"
    cmds:
      - |
        git add .
        git commit -m "{{.CLI_ARGS}}"
        echo "âœ… Changes committed"
    silent: true

  git:tag:
    desc: Create version tag for current version
    cmds:
      - |
        git tag -a "v{{.VERSION}}" -m "Release v{{.VERSION}}"
        echo "âœ… Tag v{{.VERSION}} created"
        echo "   Push with: git push origin main --tags"
    silent: true

  # =============================================================================
  # INFORMATION & HELP
  # =============================================================================

  info:show:
    desc: Show addon information
    cmds:
      - |
        echo "ğŸ“¦ Addon Information"
        echo "===================="
        echo "Name:        {{.ADDON_NAME}}"
        echo "Version:     {{.VERSION}}"
        echo "Manifest:    {{.MANIFEST_FILE}}"
        echo "Location:    {{.PWD}}"
        echo "ESO Live:    {{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}"
        echo "ESO PTS:     {{.ESO_PTS_ADDONS}}/{{.ADDON_NAME}}"
        echo ""
        echo "Core Files:"
        ls -lh {{.MANIFEST_FILE}} README.md LICENSE
        echo ""
        echo "Source Files:"
        find {{.SRC_DIR}} -name "*.lua" -type f | wc -l | xargs echo "  Lua files:"
    silent: true

  info:size:
    desc: Show file sizes and package size
    cmds:
      - |
        echo "ğŸ“Š File Sizes:"
        du -h {{.MANIFEST_FILE}} README.md LICENSE
        echo ""
        echo "Source Directory:"
        du -sh {{.SRC_DIR}}/
        echo ""
        echo "Total project size:"
        du -sh .
        echo ""
        echo "Distribution size:"
        du -sh {{.DIST_DIR}} 2>/dev/null || echo "  (not built yet - run 'task build:release')"
    silent: true

  info:docs:
    desc: Show documentation files
    cmds:
      - echo "ğŸ“– Documentation files:"
      - echo "  - README.md (user guide)"
      - echo "  - CHANGELOG.md (version history)"
      - echo "  - docs/ACTION_PLAN.md (testing and release)"
      - echo "  - docs/COMPLIANCE_REPORT.md (ESO guidelines compliance)"
      - echo "  - docs/UPDATE_PATTERNS.md (update remaining modules)"
      - echo "  - docs/PROGRESS_CHART.md (visual progress)"
    silent: true

  info:docs:serve:
    desc: Serve documentation locally (requires Python)
    cmds:
      - echo "ğŸ“š Serving docs at http://localhost:8000"
      - python3 -m http.server 8000
    silent: true

  help:install:
    desc: Show installation help
    cmds:
      - echo "ğŸ“¥ Installation Commands:"
      - echo "  task install:live            - Copy source files to ESO Live (fast)"
      - echo "  task install:pts             - Copy source files to ESO PTS (fast)"
      - echo "  task install:built           - Install built/validated files to ESO Live"
      - echo "  task install:built:pts       - Install built/validated files to ESO PTS"
      - echo "  task install:dev             - Symlink for live development"
      - echo "  task install:uninstall:live  - Remove from ESO Live"
      - echo "  task install:uninstall:pts   - Remove from ESO PTS"
      - echo "  task install:uninstall:dev   - Remove symlink"
      - echo "  task install:clean:savedvars - Remove saved variables for clean reinstall"
      - echo ""
      - echo "ğŸ’¡ Use Cases:"
      - echo "  install:live/dev       - Fast development iteration"
      - echo "  install:built          - Release testing with validated files"
    silent: true

  help:release:
    desc: Show release workflow help
    cmds:
      - echo "ğŸš€ Release Workflow:"
      - echo ""
      - echo "GUIDED WORKFLOW (Recommended):"
      - echo "  task release                    - Interactive guided release"
      - echo "  task release:workflow           - Same as above"
      - echo ""
      - echo "AUTOMATED VALIDATION:"
      - echo "  task release:check              - Comprehensive pre-release validation"
      - echo "  task release:checklist          - Display checklist"
      - echo ""
      - echo "MANUAL WORKFLOW:"
      - echo "  1. task version:bump -- patch   - Bump version (patch/minor/major)"
      - echo "  2. Edit CHANGELOG.md            - Add release notes"
      - echo "  3. task release:check           - Run all validations"
      - echo "  4. task git:commit -- 'Release vX.X.X'"
      - echo "  5. task release:tag             - Create and push tag"
      - echo "  6. GitHub Actions handles the rest!"
      - echo ""
      - echo "VALIDATION TASKS:"
      - echo "  task test                       - Lint + validate"
      - echo "  task validate                   - All validations"
      - echo "  task lint                       - Luacheck only"
      - echo "  task build                      - Build release ZIP"
      - echo ""
      - echo "GIT HOOKS (Optional):"
      - echo "  task git:hooks:install          - Install pre-push validation hook"
      - echo "  task git:hooks:test             - Test the hook"
      - echo ""
      - echo "For full checklist see RELEASE_CHECKLIST.md"
    silent: true

  help:dev:
    desc: Show development help
    cmds:
      - echo "ğŸ”¥ Development Workflow:"
      - echo "  1. task install:dev     - Setup dev mode (symlink)"
      - echo "  2. Edit .lua/.xml files"
      - echo "  3. /reloadui in ESO     - Test changes instantly"
      - echo "  4. task dev:lint        - Check code quality"
      - echo "  5. task dev:format      - Format code"
      - echo "  6. task dev:test        - Full validation"
      - echo "  7. git commit           - Pre-commit hooks run automatically"
    silent: true

  # =============================================================================
  # EXAMPLES & MARKDOWN FORMATTING
  # =============================================================================


  examples:trim:dry-run:
    desc: Preview what would be trimmed without modifying files
    cmds:
      - |
        echo "ğŸ” Dry run: checking example files..."
        python3 scripts/trim.py --dry-run examples/*.md examples/*.tonl
    silent: true

  # =============================================================================
  # DOCUMENTATION (mdBook)
  # =============================================================================

  docs:audit:
    desc: Comprehensive documentation audit (duplication, staleness, orphans, broken links)
    cmds:
      - |
        echo "ğŸ“š Documentation Audit"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        
        # 1. Find all documentation files
        echo "ğŸ“„ Documentation Files:"
        DOC_COUNT=$(find . -type f \( -name "*.md" -o -name "*.txt" \) \
          ! -path "*/node_modules/*" \
          ! -path "*/book/*" \
          ! -path "*/.task/*" \
          ! -path "*/dist/*" \
          ! -path "*/build/*" | wc -l | tr -d ' ')
        echo "   Total: $DOC_COUNT files"
        echo ""
        
        # 2. Check for stale documentation (not modified in 6+ months)
        echo "ğŸ“… Stale Documentation (6+ months old):"
        STALE=$(find . -type f \( -name "*.md" -o -name "*.txt" \) \
          ! -path "*/node_modules/*" \
          ! -path "*/book/*" \
          ! -path "*/.task/*" \
          ! -path "*/examples/*" \
          -mtime +180 2>/dev/null)
        if [ -n "$STALE" ]; then
          echo "$STALE" | while read file; do
            DAYS=$(( ( $(date +%s) - $(stat -f %m "$file" 2>/dev/null || stat -c %Y "$file") ) / 86400 ))
            echo "   âš ï¸  $file (${DAYS} days old)"
          done
        else
          echo "   âœ“ No stale files found"
        fi
        echo ""
        
        # 3. Find orphaned documentation (not linked from anywhere)
        echo "ğŸ”— Checking for Orphaned Files:"
        ORPHANS=0
        find . -type f -name "*.md" \
          ! -path "*/node_modules/*" \
          ! -path "*/book/*" \
          ! -path "*/.task/*" \
          ! -name "README.md" \
          ! -name "CHANGELOG.md" \
          ! -name "LICENSE.md" | while read doc; do
          BASENAME=$(basename "$doc")
          # Check if file is referenced anywhere
          if ! grep -r -q "$BASENAME" --include="*.md" --include="*.yaml" --include="book.toml" --exclude-dir=node_modules --exclude-dir=book --exclude-dir=.task . 2>/dev/null; then
            echo "   âš ï¸  $doc (not referenced)"
            ORPHANS=$((ORPHANS + 1))
          fi
        done
        if [ $ORPHANS -eq 0 ]; then
          echo "   âœ“ No orphaned files found"
        fi
        echo ""
        
        # 4. Find potential duplicates (files with similar names)
        echo "ğŸ“‹ Potential Duplicate Topics:"
        find . -type f -name "*.md" \
          ! -path "*/node_modules/*" \
          ! -path "*/book/*" \
          ! -path "*/.task/*" \
          -exec basename {} \; | sort | uniq -c | awk '$1 > 1 {print "   âš ï¸  " $2 " appears in " $1 " locations"}'
        echo ""
        
        # 5. Check documentation size
        echo "ğŸ“Š Documentation Size:"
        TOTAL_SIZE=$(find . -type f \( -name "*.md" -o -name "*.txt" \) \
          ! -path "*/node_modules/*" \
          ! -path "*/book/*" \
          ! -path "*/.task/*" \
          -exec wc -c {} + 2>/dev/null | tail -1 | awk '{print $1}')
        if [ -n "$TOTAL_SIZE" ]; then
          SIZE_MB=$(echo "scale=2; $TOTAL_SIZE / 1024 / 1024" | bc)
          echo "   Total: ${SIZE_MB}MB"
        fi
        
        TOTAL_LINES=$(find . -type f \( -name "*.md" -o -name "*.txt" \) \
          ! -path "*/node_modules/*" \
          ! -path "*/book/*" \
          ! -path "*/.task/*" \
          -exec wc -l {} + 2>/dev/null | tail -1 | awk '{print $1}')
        if [ -n "$TOTAL_LINES" ]; then
          echo "   Total: ${TOTAL_LINES} lines"
        fi
        echo ""
        
        # 6. Summary
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… Audit complete"
        echo ""
        echo "Next steps:"
        echo "  task docs:stale       - List stale files with details"
        echo "  task docs:orphans     - Find orphaned files"
        echo "  task docs:duplicates  - Check for duplicate content"
        echo "  task docs:links       - Check all links"
    silent: true

  docs:stale:
    desc: List stale documentation files (not modified in 6+ months)
    cmds:
      - |
        echo "ğŸ“… Stale Documentation Files"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        
        STALE=$(find . -type f \( -name "*.md" -o -name "*.txt" \) \
          ! -path "*/node_modules/*" \
          ! -path "*/book/*" \
          ! -path "*/.task/*" \
          ! -path "*/examples/*" \
          -mtime +180 2>/dev/null)
        
        if [ -n "$STALE" ]; then
          echo "Files not modified in 6+ months:"
          echo ""
          echo "$STALE" | while read file; do
            DAYS=$(( ( $(date +%s) - $(stat -f %m "$file" 2>/dev/null || stat -c %Y "$file") ) / 86400 ))
            LINES=$(wc -l < "$file" 2>/dev/null || echo "0")
            echo "ğŸ“„ $file"
            echo "   Age: ${DAYS} days (~$((DAYS / 30)) months)"
            echo "   Size: ${LINES} lines"
            echo "   Last modified: $(stat -f %Sm -t "%Y-%m-%d" "$file" 2>/dev/null || stat -c %y "$file" | cut -d' ' -f1)"
            echo ""
          done
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Review these files:"
          echo "  - Are they still relevant?"
          echo "  - Should they be updated?"
          echo "  - Should they be archived/removed?"
          echo "  - Should they be consolidated into other docs?"
        else
          echo "âœ… No stale documentation found"
          echo "   All documentation has been updated within the last 6 months"
        fi
    silent: true

  docs:orphans:
    desc: Find orphaned documentation files (not referenced anywhere)
    cmds:
      - |
        echo "ğŸ”— Orphaned Documentation Files"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "Files not referenced in any other documentation:"
        echo ""
        
        FOUND=0
        find . -type f -name "*.md" \
          ! -path "*/node_modules/*" \
          ! -path "*/book/*" \
          ! -path "*/.task/*" \
          ! -path "*/examples/*" \
          ! -name "README.md" \
          ! -name "CHANGELOG.md" \
          ! -name "LICENSE.md" | while read doc; do
          BASENAME=$(basename "$doc")
          FILENAME="${BASENAME%.*}"
          
          # Check if file is referenced anywhere
          REFS=$(grep -r -l "$BASENAME\|$FILENAME" \
            --include="*.md" \
            --include="*.yaml" \
            --include="*.toml" \
            --exclude-dir=node_modules \
            --exclude-dir=book \
            --exclude-dir=.task \
            . 2>/dev/null | grep -v "$doc" | wc -l | tr -d ' ')
          
          if [ "$REFS" -eq 0 ]; then
            echo "ğŸ“„ $doc"
            LINES=$(wc -l < "$doc" 2>/dev/null || echo "0")
            echo "   Size: ${LINES} lines"
            echo "   Not referenced in any other files"
            echo ""
            FOUND=$((FOUND + 1))
          fi
        done
        
        if [ $FOUND -eq 0 ]; then
          echo "âœ… No orphaned files found"
          echo "   All documentation is referenced somewhere"
        else
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Consider:"
          echo "  - Adding references to these files in docs/SUMMARY.md or README.md"
          echo "  - Consolidating content into other files"
          echo "  - Removing if no longer needed"
        fi
    silent: true

  docs:duplicates:
    desc: Find potential duplicate content in documentation
    cmds:
      - |
        echo "ğŸ“‹ Duplicate Content Detection"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        
        # Check for files with similar names
        echo "Files with similar names:"
        find . -type f -name "*.md" \
          ! -path "*/node_modules/*" \
          ! -path "*/book/*" \
          ! -path "*/.task/*" \
          ! -path "*/examples/*" \
          -exec basename {} \; | sort | while read file; do
          COUNT=$(find . -type f -name "$file" \
            ! -path "*/node_modules/*" \
            ! -path "*/book/*" \
            ! -path "*/.task/*" | wc -l | tr -d ' ')
          if [ "$COUNT" -gt 1 ]; then
            echo "  âš ï¸  $file (found in $COUNT locations)"
            find . -type f -name "$file" \
              ! -path "*/node_modules/*" \
              ! -path "*/book/*" \
              ! -path "*/.task/*" | sed 's/^/     /'
          fi
        done
        echo ""
        
        # Check for potential topic duplication by looking at headings
        echo "Checking for duplicate topics (by heading analysis):"
        echo "  (Looking for same H1 headings in different files)"
        echo ""
        
        TEMP_FILE=$(mktemp)
        find . -type f -name "*.md" \
          ! -path "*/node_modules/*" \
          ! -path "*/book/*" \
          ! -path "*/.task/*" \
          ! -path "*/examples/*" | while read file; do
          grep "^# " "$file" 2>/dev/null | sed "s/^# //" | while read heading; do
            echo "$heading|$file" >> "$TEMP_FILE"
          done
        done
        
        if [ -s "$TEMP_FILE" ]; then
          cat "$TEMP_FILE" | awk -F'|' '{print $1}' | sort | uniq -c | while read count heading; do
            if [ "$count" -gt 1 ]; then
              echo "  âš ï¸  \"$heading\" appears in $count files:"
              grep "^$heading|" "$TEMP_FILE" | awk -F'|' '{print "     " $2}'
            fi
          done
        fi
        
        rm -f "$TEMP_FILE"
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "Review duplicates and consider:"
        echo "  - Consolidating into a single authoritative document"
        echo "  - Removing outdated versions"
        echo "  - Cross-referencing if both are needed"
    silent: true

  docs:links:
    desc: Check documentation for broken internal links and references
    cmds:
      - |
        echo "ğŸ”— Documentation Link Checker"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "Checking internal markdown links..."
        echo ""
        
        BROKEN=0
        find . -type f -name "*.md" \
          ! -path "*/node_modules/*" \
          ! -path "*/book/*" \
          ! -path "*/.task/*" | while read file; do
          
          # Extract markdown links [text](path)
          grep -o '\[.*\]([^)]*\.md[^)]*)' "$file" 2>/dev/null | \
          sed 's/.*(\([^)]*\)).*/\1/' | while read link; do
            # Resolve relative paths
            DIR=$(dirname "$file")
            TARGET=$(cd "$DIR" && realpath -m "$link" 2>/dev/null || echo "$DIR/$link")
            
            if [ ! -f "$TARGET" ]; then
              echo "  âŒ Broken link in $file"
              echo "     Link: $link"
              echo "     Target not found: $TARGET"
              echo ""
              BROKEN=$((BROKEN + 1))
            fi
          done
        done
        
        if [ $BROKEN -eq 0 ]; then
          echo "âœ… All internal markdown links are valid"
        fi
        echo ""
        
        # Check for references to files that don't exist
        echo "Checking file references in documentation..."
        echo ""
        
        find . -type f -name "*.md" \
          ! -path "*/node_modules/*" \
          ! -path "*/book/*" \
          ! -path "*/.task/*" | while read file; do
          
          # Look for common file reference patterns
          grep -oE '`[^`]+\.(lua|yaml|md|txt|sh)`' "$file" 2>/dev/null | \
          sed 's/`//g' | while read ref; do
            if [ ! -f "$ref" ] && ! find . -name "$ref" -type f 2>/dev/null | grep -q .; then
              echo "  âš ï¸  Referenced file may not exist: $ref"
              echo "     Mentioned in: $file"
              echo ""
            fi
          done
        done
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "Note: External URLs not checked (requires network connectivity)"
        echo "Use: task docs:links:external to check external links"
    silent: true

  docs:links:external:
    desc: Check external links (requires network connectivity)
    cmds:
      - |
        echo "ğŸŒ External Link Checker"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "âš ï¸  This check requires network connectivity and may be slow"
        echo ""
        
        if ! command -v curl &> /dev/null; then
          echo "âŒ curl not found. Install with: brew install curl"
          exit 1
        fi
        
        echo "Checking external HTTP(S) links..."
        echo ""
        
        find . -type f -name "*.md" \
          ! -path "*/node_modules/*" \
          ! -path "*/book/*" \
          ! -path "*/.task/*" | while read file; do
          
          grep -oE 'https?://[^)]+' "$file" 2>/dev/null | sort -u | while read url; do
            # Clean up URL (remove trailing punctuation)
            url=$(echo "$url" | sed 's/[,;.]$//')
            
            HTTP_CODE=$(curl -o /dev/null -s -w "%{http_code}" -L --max-time 5 "$url" 2>/dev/null || echo "000")
            
            if [ "$HTTP_CODE" -ge 400 ] || [ "$HTTP_CODE" -eq "000" ]; then
              echo "  âŒ Broken link (HTTP $HTTP_CODE): $url"
              echo "     Found in: $file"
              echo ""
            fi
          done
        done
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… External link check complete"
    silent: true

  docs:consolidate:
    desc: Interactive documentation consolidation workflow
    cmds:
      - |
        echo "ğŸ“š Documentation Consolidation Workflow"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "This workflow will help you:"
        echo "  1. Identify documentation issues"
        echo "  2. Review and consolidate content"
        echo "  3. Clean up obsolete files"
        echo ""
        
        # Run audit
        echo "Step 1: Running documentation audit..."
        task docs:audit
        echo ""
        
        # Prompt for stale file review
        read -p "Review stale files? (y/N): " REVIEW_STALE
        if [ "$REVIEW_STALE" = "y" ] || [ "$REVIEW_STALE" = "Y" ]; then
          task docs:stale
          echo ""
        fi
        
        # Prompt for orphan review
        read -p "Review orphaned files? (y/N): " REVIEW_ORPHANS
        if [ "$REVIEW_ORPHANS" = "y" ] || [ "$REVIEW_ORPHANS" = "Y" ]; then
          task docs:orphans
          echo ""
        fi
        
        # Prompt for duplicate review
        read -p "Check for duplicates? (y/N): " REVIEW_DUPS
        if [ "$REVIEW_DUPS" = "y" ] || [ "$REVIEW_DUPS" = "Y" ]; then
          task docs:duplicates
          echo ""
        fi
        
        # Prompt for link checking
        read -p "Check for broken links? (y/N): " REVIEW_LINKS
        if [ "$REVIEW_LINKS" = "y" ] || [ "$REVIEW_LINKS" = "Y" ]; then
          task docs:links
          echo ""
        fi
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… Documentation review complete"
        echo ""
        echo "Next steps:"
        echo "  1. Review flagged issues above"
        echo "  2. Consolidate or remove obsolete content"
        echo "  3. Update references and links"
        echo "  4. Run 'task docs:audit' again to verify improvements"
    silent: true

  docs:install:
    desc: Verify mdbook is installed
    cmds:
      - |
        if ! command -v mdbook &> /dev/null; then
          echo "âŒ mdbook not found. Install with: brew install mdbook"
          exit 1
        fi
        echo "âœ… mdbook is installed"
        mdbook --version
    silent: true

  docs:serve:
    desc: Start mdBook development server (auto-reload on changes)
    cmds:
      - task: docs:install
      - echo "ğŸ“š Starting mdBook server..."
      - echo "   Open http://localhost:3000 in your browser"
      - echo "   Press Ctrl+C to stop"
      - mdbook serve --open

  docs:build:
    desc: Build static documentation site
    cmds:
      - task: docs:install
      - echo "ğŸ“š Building documentation..."
      - mdbook build
      - echo "âœ… Documentation built in book/ directory"

  docs:clean:
    desc: Remove mdBook build artifacts
    cmds:
      - echo "ğŸ§¹ Cleaning mdBook build artifacts..."
      - mdbook clean
      - echo "âœ… Cleaned"

  docs:test:
    desc: Test documentation links
    cmds:
      - task: docs:install
      - echo "ğŸ” Testing documentation links..."
      - mdbook test
      - echo "âœ… All links valid"

  docs:deploy:
    desc: Build and prepare for GitHub Pages deployment
    cmds:
      - task: docs:build
      - echo "ğŸ“¦ Documentation ready for deployment"
      - echo "   Push book/ directory to gh-pages branch or use GitHub Actions"

  # =============================================================================
  # BACKWARD COMPATIBILITY ALIASES
  # =============================================================================

  lint:
    desc: Alias for dev:lint
    cmds:
      - task: dev:lint
    silent: true

  format:
    desc: Alias for dev:format
    cmds:
      - task: dev:format
    silent: true

  test:
    desc: Alias for dev:test
    cmds:
      - task: dev:test
    silent: true

  validate:
    desc: Alias for dev:validate:all
    cmds:
      - task: dev:validate:all
    silent: true

  validate:syntax:
    desc: Alias for dev:validate:syntax
    cmds:
      - task: dev:validate:syntax
    silent: true

  validate:manifest:
    desc: Alias for dev:validate:manifest
    cmds:
      - task: dev:validate:manifest
    silent: true

  validate:files:
    desc: Alias for dev:validate:files
    cmds:
      - task: dev:validate:files
    silent: true

  validate:changelog:
    desc: Alias for dev:validate:changelog
    cmds:
      - task: dev:validate:changelog
    silent: true

  validate:readme:
    desc: Alias for dev:validate:readme
    cmds:
      - task: dev:validate:readme
    silent: true

  build:
    desc: Alias for build:release
    cmds:
      - task: build:release
    silent: true

  clean:
    desc: Alias for build:clean
    cmds:
      - task: build:clean
    silent: true

  version:
    desc: Alias for version:show
    cmds:
      - task: version:show
    silent: true

  release:
    desc: Alias for release:workflow (guided release process)
    cmds:
      - task: release:workflow
    silent: true
  examples:trim:
    desc: Trim unnecessary newlines from example files
    cmds:
      - |
        echo "âœ‚ï¸  Trimming example files..."
        python3 scripts/trim.py examples/*.md examples/*.tonl
    silent: true

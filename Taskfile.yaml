version: '3'

# CharacterMarkdown - Developer Task Automation
# Requires: Task (https://taskfile.dev)
# Install: brew install go-task/tap/go-task

vars:
  ADDON_NAME: CharacterMarkdown
  # Updated: Use .addon manifest (Console-compatible format)
  MANIFEST_FILE: CharacterMarkdown.addon
  VERSION:
    sh: grep "## Version:" {{.MANIFEST_FILE}} | awk '{print $3}'
  # Directories
  ESO_LIVE_ADDONS: "{{.HOME}}/Documents/Elder Scrolls Online/live/AddOns"
  ESO_PTS_ADDONS: "{{.HOME}}/Documents/Elder Scrolls Online/pts/AddOns"
  ESO_LIVE_SAVEDVARS: "{{.HOME}}/Documents/Elder Scrolls Online/live/SavedVariables"
  BUILD_DIR: build
  DIST_DIR: dist
  SRC_DIR: src
  
  # Required files
  REQUIRED_FILES: "{{.MANIFEST_FILE}} {{.ADDON_NAME}}.xml README.md LICENSE"

tasks:
  # =============================================================================
  # DEFAULT TASK
  # =============================================================================
  
  default:
    desc: Show available tasks
    cmds:
      - task --list-all
    silent: true

  # =============================================================================
  # DEPENDENCY INSTALLATION
  # =============================================================================
  
  install:deps:
    desc: Install development dependencies (LuaJIT, Luacheck, pre-commit)
    cmds:
      - echo "üì¶ Installing development dependencies..."
      - brew list luajit &>/dev/null || brew install luajit
      - brew list luarocks &>/dev/null || brew install luarocks
      - luarocks list luacheck | grep -q luacheck || luarocks install luacheck
      - command -v pre-commit &>/dev/null || brew install pre-commit
      - pre-commit install
      - echo "‚úÖ Dependencies installed successfully"
      - echo ""
      - echo "Installed:"
      - luajit -v
      - luacheck --version
      - pre-commit --version

  # =============================================================================
  # ESO INSTALLATION TASKS
  # =============================================================================
  
  install:live:
    desc: Install addon to ESO Live client (copy)
    cmds:
      - |
        echo "üì• Installing {{.ADDON_NAME}} to ESO Live..."
        mkdir -p "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}/{{.SRC_DIR}}"
        
        # Copy manifest (.addon format)
        cp {{.MANIFEST_FILE}} "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}/"
        
        # Copy other core files
        cp {{.ADDON_NAME}}.xml "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}/"
        
        # Copy assets directory if exists
        if [ -d "assets" ]; then
          cp -r assets/ "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}/assets/"
          echo "  ‚úì Copied assets/"
        fi
        
        # Copy source files
        cp -r {{.SRC_DIR}}/ "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}/{{.SRC_DIR}}"
        echo "  ‚úì Copied {{.SRC_DIR}}/"
        
        # Copy optional documentation files
        if [ -f "README.md" ]; then
          cp README.md "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}/"
          echo "  ‚úì Copied README.md"
        fi
        
        if [ -f "LICENSE" ]; then
          cp LICENSE "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}/"
          echo "  ‚úì Copied LICENSE"
        fi
        
        echo "‚úÖ Installed to {{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}"
    silent: true

  install:pts:
    desc: Install addon to ESO PTS client (copy)
    cmds:
      - |
        echo "üì• Installing {{.ADDON_NAME}} to ESO PTS..."
        mkdir -p "{{.ESO_PTS_ADDONS}}/{{.ADDON_NAME}}/{{.SRC_DIR}}"
        
        # Copy manifest
        cp {{.MANIFEST_FILE}} "{{.ESO_PTS_ADDONS}}/{{.ADDON_NAME}}/"
        
        # Copy other core files
        cp {{.ADDON_NAME}}.xml "{{.ESO_PTS_ADDONS}}/{{.ADDON_NAME}}/"
        
        # Copy assets directory if exists
        if [ -d "assets" ]; then
          cp -r assets/ "{{.ESO_PTS_ADDONS}}/{{.ADDON_NAME}}/assets/"
          echo "  ‚úì Copied assets/"
        fi
        
        # Copy settings directory if exists
        if [ -d "settings" ]; then
          cp -r settings/ "{{.ESO_PTS_ADDONS}}/{{.ADDON_NAME}}/settings/"
          echo "  ‚úì Copied settings/"
        fi
        
        # Copy source files
        cp -r {{.SRC_DIR}}/ "{{.ESO_PTS_ADDONS}}/{{.ADDON_NAME}}/{{.SRC_DIR}}"
        echo "  ‚úì Copied {{.SRC_DIR}}/"
        
        # Copy optional documentation files
        if [ -f "README.md" ]; then
          cp README.md "{{.ESO_PTS_ADDONS}}/{{.ADDON_NAME}}/"
          echo "  ‚úì Copied README.md"
        fi
        
        if [ -f "LICENSE" ]; then
          cp LICENSE "{{.ESO_PTS_ADDONS}}/{{.ADDON_NAME}}/"
          echo "  ‚úì Copied LICENSE"
        fi
        
        echo "‚úÖ Installed to {{.ESO_PTS_ADDONS}}/{{.ADDON_NAME}}"
    silent: true

  install:dev:
    desc: Install addon as symlink for live development
    cmds:
      - |
        echo "üîó Creating development symlink..."
        rm -rf "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}"
        ln -s "{{.PWD}}" "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}"
        echo "‚úÖ Development symlink created"
        echo "   Edit files here, use /reloadui in-game to test"
    silent: true

  install:built:
    desc: Install built/validated files to ESO Live client
    deps: [build]
    cmds:
      - |
        echo "üì¶ Installing built {{.ADDON_NAME}} to ESO Live..."
        rm -rf "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}"
        cp -r "{{.BUILD_DIR}}/{{.ADDON_NAME}}" "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}"
        echo "‚úÖ Built addon installed to {{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}"
        echo "   Files validated and ready for testing"
    silent: true

  install:built:pts:
    desc: Install built/validated files to ESO PTS client
    deps: [build]
    cmds:
      - |
        echo "üì¶ Installing built {{.ADDON_NAME}} to ESO PTS..."
        rm -rf "{{.ESO_PTS_ADDONS}}/{{.ADDON_NAME}}"
        cp -r "{{.BUILD_DIR}}/{{.ADDON_NAME}}" "{{.ESO_PTS_ADDONS}}/{{.ADDON_NAME}}"
        echo "‚úÖ Built addon installed to {{.ESO_PTS_ADDONS}}/{{.ADDON_NAME}}"
        echo "   Files validated and ready for testing"
    silent: true

  uninstall:live:
    desc: Remove addon from ESO Live client
    cmds:
      - |
        echo "üóëÔ∏è  Removing {{.ADDON_NAME}} from ESO Live..."
        rm -rf "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}"
        echo "‚úÖ Uninstalled from Live"
    silent: true

  uninstall:pts:
    desc: Remove addon from ESO PTS client
    cmds:
      - |
        echo "üóëÔ∏è  Removing {{.ADDON_NAME}} from ESO PTS..."
        rm -rf "{{.ESO_PTS_ADDONS}}/{{.ADDON_NAME}}"
        echo "‚úÖ Uninstalled from PTS"
    silent: true

  uninstall:dev:
    desc: Remove development symlink and install normally
    cmds:
      - |
        echo "üóëÔ∏è  Removing development symlink..."
        rm -rf "{{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}"
        echo "‚úÖ Symlink removed"
        echo ""
      - task: install:live
    silent: true

  clean:savedvars:
    desc: Remove saved variables file for clean reinstall
    cmds:
      - |
        echo "üóëÔ∏è  Removing saved variables..."
        if [ -f "{{.ESO_LIVE_SAVEDVARS}}/{{.ADDON_NAME}}.lua" ]; then
          rm -f "{{.ESO_LIVE_SAVEDVARS}}/{{.ADDON_NAME}}.lua"
          echo "‚úÖ Saved variables removed"
        else
          echo "‚ÑπÔ∏è  No saved variables file found"
        fi
    silent: true

  # =============================================================================
  # VALIDATION & LINTING
  # =============================================================================
  
  lint:
    desc: Run Luacheck on all Lua files
    cmds:
      - |
        echo "üîç Running Luacheck..."
        luacheck {{.SRC_DIR}} --exclude-files "*.backup" --exclude-files ".task/**" --ignore 212 || true
      - echo "‚úÖ Lint passed"

  lint:fix:
    desc: Auto-fix Luacheck issues where possible
    cmds:
      - |
        echo "üîß Auto-fixing Luacheck issues..."
        luacheck {{.SRC_DIR}} --exclude-files "*.backup" --exclude-files ".task/**" --ignore 212 --fix || true
      - echo "‚úÖ Auto-fix complete"

  validate:
    desc: Validate addon manifest and project structure
    cmds:
      - echo "‚úÖ Validating project..."
      - task: validate:files
      - task: validate:manifest
      - task: validate:syntax
      - echo "‚úÖ All validations passed"
    silent: true

  validate:files:
    desc: Check that all required files exist
    cmds:
      - echo "  Checking required files..."
      - |
        for file in {{.MANIFEST_FILE}} {{.ADDON_NAME}}.xml README.md LICENSE; do
          if [ ! -f "$file" ]; then
            echo "  ‚úó Missing required file: $file"
            exit 1
          fi
        done
        if [ ! -d "{{.SRC_DIR}}" ]; then
          echo "  ‚úó Missing required directory: {{.SRC_DIR}}"
          exit 1
        fi
      - echo "    ‚úì All required files present"
    silent: true

  validate:manifest:
    desc: Validate addon manifest file
    cmds:
      - echo "  Validating manifest..."
      - |
        # Basic validation - check required fields
        if ! grep -q "^## Title:" {{.MANIFEST_FILE}}; then
          echo "  ‚úó Missing Title in manifest"
          exit 1
        fi
        if ! grep -q "^## Version:" {{.MANIFEST_FILE}}; then
          echo "  ‚úó Missing Version in manifest"
          exit 1
        fi
        if ! grep -q "^## APIVersion:" {{.MANIFEST_FILE}}; then
          echo "  ‚úó Missing APIVersion in manifest"
          exit 1
        fi
        echo "    ‚úì Manifest valid"
    silent: true

  validate:syntax:
    desc: Check Lua syntax with LuaJIT
    cmds:
      - echo "  Checking Lua syntax..."
      - |
        find {{.SRC_DIR}} -name "*.lua" -type f | while read file; do
          luajit -bl "$file" > /dev/null || (echo "  ‚úó Lua syntax errors in $file" && exit 1)
        done
      - echo "    ‚úì All Lua files syntax valid"
    silent: true

  test:
    desc: Run all tests (lint + validate)
    deps: [lint, validate]
    cmds:
      - echo "‚úÖ All tests passed"

  # =============================================================================
  # BUILD & PACKAGING
  # =============================================================================

  clean:
    desc: Clean build artifacts
    cmds:
      - |
        echo "üßπ Cleaning build artifacts..."
        rm -rf {{.BUILD_DIR}}
        rm -rf {{.DIST_DIR}}
        rm -f {{.ADDON_NAME}}-*.zip
        echo "‚úÖ Clean complete"

  build:
    desc: Build release ZIP artifact with full validation
    deps: [clean, test]
    cmds:
      - |
        echo "üì¶ Building {{.ADDON_NAME}} release..."
        
        # Get version from Git (tag or commit SHA)
        if git describe --tags --exact-match HEAD >/dev/null 2>&1; then
          # On a tag
          VERSION=$(git describe --tags --exact-match HEAD | sed 's/^v//')
          echo "   Using tag version: ${VERSION}"
        else
          # Use commit SHA (matches ESOUI behavior)
          VERSION=$(git rev-parse --short HEAD)
          echo "   Using commit SHA: ${VERSION}"
        fi
        
        mkdir -p {{.BUILD_DIR}}/{{.ADDON_NAME}}
        mkdir -p {{.DIST_DIR}}
        
        # Copy files using .build-ignore exclusions
        rsync -a --quiet \
          --exclude-from=.build-ignore \
          --exclude='{{.BUILD_DIR}}' \
          --exclude='{{.DIST_DIR}}' \
          . {{.BUILD_DIR}}/{{.ADDON_NAME}}/
      - |
        # Get version again for replacement
        if git describe --tags --exact-match HEAD >/dev/null 2>&1; then
          VERSION=$(git describe --tags --exact-match HEAD | sed 's/^v//')
        else
          VERSION=$(git rev-parse --short HEAD)
        fi
        
        # Replace @project-version@ placeholders in manifest (ESOUI format)
        MANIFEST_PATH="{{.BUILD_DIR}}/{{.ADDON_NAME}}/{{.MANIFEST_FILE}}"
        ./scripts/replace-version.sh "$MANIFEST_PATH" "$VERSION"
        
        # Create ZIP with version
        cd {{.BUILD_DIR}} && zip -r -q "../{{.DIST_DIR}}/{{.ADDON_NAME}}-${VERSION}.zip" {{.ADDON_NAME}}
        echo "‚úÖ Built: {{.DIST_DIR}}/{{.ADDON_NAME}}-${VERSION}.zip"
      - |
        # Get version for validation
        if git describe --tags --exact-match HEAD >/dev/null 2>&1; then
          VERSION=$(git describe --tags --exact-match HEAD | sed 's/^v//')
        else
          VERSION=$(git rev-parse --short HEAD)
        fi
        
        # Run comprehensive ZIP validation
        chmod +x scripts/validate-zip.sh
        scripts/validate-zip.sh "{{.DIST_DIR}}/{{.ADDON_NAME}}-${VERSION}.zip"

  build:fast:
    desc: Build without tests (fast local iteration)
    deps: [clean]
    cmds:
      - |
        echo "üì¶ Building {{.ADDON_NAME}} (fast mode)..."
        
        # Get version from Git (tag or commit SHA)
        if git describe --tags --exact-match HEAD >/dev/null 2>&1; then
          VERSION=$(git describe --tags --exact-match HEAD | sed 's/^v//')
          echo "   Using tag version: ${VERSION}"
        else
          VERSION=$(git rev-parse --short HEAD)
          echo "   Using commit SHA: ${VERSION}"
        fi
        
        mkdir -p {{.BUILD_DIR}}/{{.ADDON_NAME}}
        mkdir -p {{.DIST_DIR}}
        rsync -a --quiet \
          --exclude-from=.build-ignore \
          --exclude='{{.BUILD_DIR}}' \
          --exclude='{{.DIST_DIR}}' \
          . {{.BUILD_DIR}}/{{.ADDON_NAME}}/
      - |
        # Get version again for replacement
        if git describe --tags --exact-match HEAD >/dev/null 2>&1; then
          VERSION=$(git describe --tags --exact-match HEAD | sed 's/^v//')
        else
          VERSION=$(git rev-parse --short HEAD)
        fi
        
        # Replace @project-version@ placeholders in manifest
        MANIFEST_PATH="{{.BUILD_DIR}}/{{.ADDON_NAME}}/{{.MANIFEST_FILE}}"
        ./scripts/replace-version.sh "$MANIFEST_PATH" "$VERSION"
        
        cd {{.BUILD_DIR}} && zip -r -q "../{{.DIST_DIR}}/{{.ADDON_NAME}}-${VERSION}.zip" {{.ADDON_NAME}}
        echo "‚úÖ Built: {{.DIST_DIR}}/{{.ADDON_NAME}}-${VERSION}.zip"

  package:
    desc: Alias for build (backward compatibility)
    deps: [build]

  package:esoui:
    desc: Create ESOUI-compatible package (same as build)
    deps: [build]
    cmds:
      - |
        echo "‚úÖ ESOUI package ready: {{.DIST_DIR}}/{{.ADDON_NAME}}-{{.VERSION}}.zip"

  # =============================================================================
  # VERSION MANAGEMENT
  # =============================================================================

  version:
    desc: Show current version info (Git tag/commit based)
    cmds:
      - |
        echo "üì¶ {{.ADDON_NAME}}"
        
        # Show Git version info (tag or commit)
        if git describe --tags --exact-match HEAD >/dev/null 2>&1; then
          VERSION=$(git describe --tags --exact-match HEAD | sed 's/^v//')
          echo "   Version (Tag): ${VERSION}"
        else
          VERSION=$(git rev-parse --short HEAD)
          echo "   Version (Commit): ${VERSION}"
        fi
        
        # Show API version from manifest
        if grep -q "^## APIVersion:" {{.MANIFEST_FILE}}; then
          API_VERSION=$(grep "^## APIVersion:" {{.MANIFEST_FILE}} | awk '{print $3}')
          echo "   API Version: ${API_VERSION}"
        fi
        
        # Show manifest placeholder status
        if grep -q "@project-version@" {{.MANIFEST_FILE}}; then
          echo "   Manifest: Using @project-version@ placeholder (Git-based)"
        fi
    silent: true

  version:api:
    desc: "Update ESO API version (usage: task version:api -- <API_VERSION>)"
    vars:
      API_VERSION: '{{.CLI_ARGS | default ""}}'
    cmds:
      - |
        if [ -z "{{.API_VERSION}}" ]; then
          echo "‚ùå Error: API version required"
          echo ""
          echo "Usage: task version:api -- <API_VERSION>"
          echo ""
          echo "To get current API version:"
          echo "  1. Launch ESO"
          echo "  2. Type in chat: /script d(GetAPIVersion())"
          echo "  3. Run: task version:api -- <VERSION>"
          echo ""
          echo "Example:"
          echo "  task version:api -- 101047"
          exit 1
        fi
      - |
        echo "üîÑ Updating API version to: {{.API_VERSION}}"
        chmod +x scripts/update-api-version.sh
        ./scripts/update-api-version.sh "{{.API_VERSION}}"
    silent: true

  version:bump:
    desc: "Bump version number (usage: task version:bump -- <major|minor|patch>)"
    vars:
      BUMP_TYPE: '{{.CLI_ARGS | default "patch"}}'
    cmds:
      - |
        echo "üîÑ Bumping {{.BUMP_TYPE}} version..."
        CURRENT="{{.VERSION}}"
        IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

        case "{{.BUMP_TYPE}}" in
          major)
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
            ;;
          minor)
            MINOR=$((MINOR + 1))
            PATCH=0
            ;;
          patch|*)
            PATCH=$((PATCH + 1))
            ;;
        esac

        NEW_VERSION="$MAJOR.$MINOR.$PATCH"
        echo "  $CURRENT ‚Üí $NEW_VERSION"

        # Note: Manifest uses @project-version@, so no need to update it
        echo "   (Manifest uses @project-version@ placeholder - Git-based versioning)"

        # Update CHANGELOG
        DATE=$(date +%Y-%m-%d)
        if [[ "$OSTYPE" == "darwin"* ]]; then
          sed -i '' "s/## \[Unreleased\]/## [Unreleased]\n\n## [$NEW_VERSION] - $DATE/" CHANGELOG.md
        else
          sed -i "s/## \[Unreleased\]/## [Unreleased]\n\n## [$NEW_VERSION] - $DATE/" CHANGELOG.md
        fi

        echo "‚úÖ Version bumped to $NEW_VERSION"
        echo "‚úÖ CHANGELOG.md updated"
        echo ""
        echo "Next steps:"
        echo "  1. Review CHANGELOG.md changes"
        echo "  2. Commit changes: git commit -am 'Release v$NEW_VERSION'"
        echo "  3. Create tag: git tag -a v$NEW_VERSION -m 'Release v$NEW_VERSION'"
        echo "  4. Push tag: git push origin main --tags"
        echo ""
        echo "Note: Manifest uses @project-version@ (Git-based versioning)"
        echo "      Version is automatically set from Git tags during build."
    silent: true

  # =============================================================================
  # GIT TASKS
  # =============================================================================

  git:status:
    desc: Show git status and pending changes
    cmds:
      - git status
      - echo ""
      - echo "Uncommitted changes:"
      - git diff --stat
    silent: true

  git:commit:
    desc: "Stage and commit changes (usage: task git:commit -- \"message\")"
    cmds:
      - |
        git add .
        git commit -m "{{.CLI_ARGS}}"
        echo "‚úÖ Changes committed"
    silent: true

  git:tag:
    desc: Create version tag for current version
    cmds:
      - |
        git tag -a "v{{.VERSION}}" -m "Release v{{.VERSION}}"
        echo "‚úÖ Tag v{{.VERSION}} created"
        echo "   Push with: git push origin main --tags"
    silent: true

  # =============================================================================
  # RELEASE WORKFLOW
  # =============================================================================

  release:prepare:
    desc: Prepare for release (validate and show checklist)
    cmds:
      - echo "üöÄ Preparing release..."
      - echo "‚ö†Ô∏è  Ensure CHANGELOG.md is updated with release notes"
      - echo "‚ö†Ô∏è  Ensure version in {{.MANIFEST_FILE}} is correct"
      - task: test
      - |
        VERSION="{{.VERSION}}"
        echo ""
        echo "üìã Release Checklist:"
        echo "  1. ‚úÖ Tests passed"
        echo "  2. Update CHANGELOG.md with version ${VERSION}"
        echo "  3. Commit changes: git commit -am 'Release v${VERSION}'"
        echo "  4. Create tag: git tag v${VERSION}"
        echo "  5. Push: git push origin main --tags"
        echo ""
        echo "GitHub Actions will automatically:"
        echo "  - Build release ZIP"
        echo "  - Create GitHub release"
        echo "  - Upload to ESOUI (if configured)"

  release:tag:
    desc: Create and push release tag (interactive)
    cmds:
      - |
        VERSION="{{.VERSION}}"
        echo "üìã Creating release tag v${VERSION}"
        read -p "Create tag v${VERSION}? (y/N): " CONFIRM
        if [ "$CONFIRM" = "y" ] || [ "$CONFIRM" = "Y" ]; then
          git tag -a "v${VERSION}" -m "Release v${VERSION}"
          echo "‚úÖ Tag created: v${VERSION}"
          echo ""
          read -p "Push tag to origin? (y/N): " PUSH
          if [ "$PUSH" = "y" ] || [ "$PUSH" = "Y" ]; then
            git push origin main --tags
            echo "‚úÖ Tag pushed to GitHub"
            echo "üöÄ GitHub Actions will now build and release"
          else
            echo "‚ö†Ô∏è  Tag created locally but not pushed"
            echo "   Push with: git push origin main --tags"
          fi
        else
          echo "‚ùå Tag creation cancelled"
        fi

  release:
    desc: Create full release (build, package, tag) - backward compatibility
    deps: [validate]
    cmds:
      - task: package
      - task: git:tag
      - |
        echo ""
        echo "‚úÖ Release v{{.VERSION}} ready!"
        echo ""
        echo "Next steps:"
        echo "  1. Push tag: git push origin main --tags"
        echo "  2. Upload: {{.DIST_DIR}}/{{.ADDON_NAME}}-v{{.VERSION}}.zip"
        echo "  3. GitHub Actions will handle the rest"
    silent: true

  release:github:
    desc: Create GitHub release (requires gh CLI)
    deps: [package]
    cmds:
      - |
        echo "üöÄ Creating GitHub release v{{.VERSION}}..."
        gh release create "v{{.VERSION}}" "{{.DIST_DIR}}/{{.ADDON_NAME}}-{{.VERSION}}.zip" \
          --title "v{{.VERSION}}" \
          --notes-file CHANGELOG.md
        echo "‚úÖ GitHub release created"
    silent: true

  # =============================================================================
  # DEVELOPMENT WORKFLOW
  # =============================================================================

  dev:
    desc: Start development mode (symlink + watch)
    cmds:
      - task: install:dev
      - echo ""
      - echo "üî• Development mode active!"
      - echo "  - Edit files in this directory"
      - echo "  - Use /reloadui in ESO to test changes"
      - echo "  - Press Ctrl+C to stop watching"
      - echo ""
      - task: dev:watch
    silent: true

  dev:watch:
    desc: Watch for file changes (requires fswatch)
    cmds:
      - |
        if ! command -v fswatch &> /dev/null; then
          echo "‚ö†Ô∏è  fswatch not installed. Install with: brew install fswatch"
          exit 1
        fi
        echo "üëÄ Watching for changes..."
        fswatch -o {{.ADDON_NAME}}.xml {{.SRC_DIR}}/ | while read; do
          echo "[$(date +%H:%M:%S)] Files changed - use /reloadui in ESO"
        done
    silent: true

  dev:lint:
    desc: Lint Lua code (alias for lint)
    cmds:
      - task: lint

  # =============================================================================
  # DOCUMENTATION & INFO
  # =============================================================================

  info:
    desc: Show addon information
    cmds:
      - |
        echo "üì¶ Addon Information"
        echo "===================="
        echo "Name:        {{.ADDON_NAME}}"
        echo "Version:     {{.VERSION}}"
        echo "Manifest:    {{.MANIFEST_FILE}}"
        echo "Location:    {{.PWD}}"
        echo "ESO Live:    {{.ESO_LIVE_ADDONS}}/{{.ADDON_NAME}}"
        echo "ESO PTS:     {{.ESO_PTS_ADDONS}}/{{.ADDON_NAME}}"
        echo ""
        echo "Core Files:"
        ls -lh {{.MANIFEST_FILE}} {{.ADDON_NAME}}.xml README.md LICENSE
        echo ""
        echo "Source Files:"
        find {{.SRC_DIR}} -name "*.lua" -type f | wc -l | xargs echo "  Lua files:"
    silent: true

  size:
    desc: Show file sizes and package size
    cmds:
      - |
        echo "üìä File Sizes:"
        du -h {{.MANIFEST_FILE}} {{.ADDON_NAME}}.xml README.md LICENSE
        echo ""
        echo "Source Directory:"
        du -sh {{.SRC_DIR}}/
        echo ""
        echo "Total project size:"
        du -sh .
        echo ""
        echo "Distribution size:"
        du -sh {{.DIST_DIR}} 2>/dev/null || echo "  (not built yet - run 'task build')"
    silent: true

  backup:
    desc: Create backup of current addon
    cmds:
      - |
        BACKUP_NAME="backup-{{.ADDON_NAME}}-$(date +%Y%m%d-%H%M%S).tar.gz"
        echo "üíæ Creating backup: $BACKUP_NAME"
        tar czf "$BACKUP_NAME" {{.MANIFEST_FILE}} {{.ADDON_NAME}}.xml README.md LICENSE {{.SRC_DIR}}/
        echo "‚úÖ Backup created: $BACKUP_NAME"
    silent: true

  docs:
    desc: Show documentation files
    cmds:
      - echo "üìñ Documentation files:"
      - echo "  - README.md (user guide)"
      - echo "  - CHANGELOG.md (version history)"
      - echo "  - docs/ACTION_PLAN.md (testing and release)"
      - echo "  - docs/COMPLIANCE_REPORT.md (ESO guidelines compliance)"
      - echo "  - docs/UPDATE_PATTERNS.md (update remaining modules)"
      - echo "  - docs/PROGRESS_CHART.md (visual progress)"
    silent: true

  docs:serve:
    desc: Serve documentation locally (requires Python)
    cmds:
      - echo "üìö Serving docs at http://localhost:8000"
      - python3 -m http.server 8000
    silent: true

  # =============================================================================
  # MINION / ESOUI TASKS
  # =============================================================================

  minion:prepare:
    desc: Prepare package for Minion/ESOUI upload
    deps: [package:esoui]
    cmds:
      - |
        echo "üì¶ Package ready for ESOUI/Minion:"
        echo "   {{.DIST_DIR}}/{{.ADDON_NAME}}-{{.VERSION}}.zip"
        echo ""
        echo "Upload options:"
        echo "  1. Manual: https://www.esoui.com/downloads/upload-update.php"
        echo "  2. Automated: Push git tag (GitHub Actions handles upload)"
    silent: true

  minion:verify:
    desc: Verify package meets ESOUI requirements
    cmds:
      - echo "‚úÖ Verifying ESOUI package requirements..."
      - |
        if [ ! -f "{{.DIST_DIR}}/{{.ADDON_NAME}}-{{.VERSION}}.zip" ]; then
          echo "‚ùå Package not found. Run: task build"
          exit 1
        fi
      - echo "  ‚úì Package exists"
      - |
        SIZE=$(stat -f%z "{{.DIST_DIR}}/{{.ADDON_NAME}}-{{.VERSION}}.zip" 2>/dev/null || stat -c%s "{{.DIST_DIR}}/{{.ADDON_NAME}}-{{.VERSION}}.zip")
        SIZE_MB=$((SIZE / 1024 / 1024))
        if [ $SIZE_MB -gt 10 ]; then
          echo "  ‚ö†Ô∏è  Warning: Package >10MB (${SIZE_MB}MB)"
        else
          echo "  ‚úì Package size OK (${SIZE_MB}MB)"
        fi
      - echo "  ‚úì Ready for ESOUI/Minion upload"
    silent: true

  # =============================================================================
  # HELP TASKS
  # =============================================================================

  help:install:
    desc: Show installation help
    cmds:
      - echo "üì• Installation Commands:"
      - echo "  task install:live      - Copy source files to ESO Live (fast)"
      - echo "  task install:pts       - Copy source files to ESO PTS (fast)"
      - echo "  task install:built     - Install built/validated files to ESO Live"
      - echo "  task install:built:pts - Install built/validated files to ESO PTS"
      - echo "  task install:dev       - Symlink for live development"
      - echo "  task uninstall:live    - Remove from ESO Live"
      - echo "  task uninstall:pts     - Remove from ESO PTS"
      - echo "  task uninstall:dev     - Remove symlink"
      - echo "  task clean:savedvars   - Remove saved variables for clean reinstall"
      - echo ""
      - echo "üí° Use Cases:"
      - echo "  install:live/dev       - Fast development iteration"
      - echo "  install:built          - Release testing with validated files"
    silent: true

  help:release:
    desc: Show release workflow help
    cmds:
      - echo "üöÄ Release Workflow:"
      - echo "  1. task version:bump -- patch   (or minor/major)"
      - echo "  2. Edit CHANGELOG.md"
      - echo "  3. task test                    (validate everything)"
      - echo "  4. task git:commit -- 'Release vX.X.X'"
      - echo "  5. task release:tag             (creates and pushes tag)"
      - echo "  6. GitHub Actions handles the rest!"
      - echo ""
      - echo "Alternative (manual):"
      - echo "  task release:prepare    - Show checklist"
      - echo "  git tag vX.X.X"
      - echo "  git push origin main --tags"
    silent: true

  help:dev:
    desc: Show development help
    cmds:
      - echo "üî• Development Workflow:"
      - echo "  1. task install:dev     - Setup dev mode (symlink)"
      - echo "  2. Edit .lua/.xml files"
      - echo "  3. /reloadui in ESO     - Test changes instantly"
      - echo "  4. task lint            - Check code quality"
      - echo "  5. task test            - Full validation"
      - echo "  6. git commit           - Pre-commit hooks run automatically"
    silent: true

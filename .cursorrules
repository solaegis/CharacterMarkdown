# CharacterMarkdown - Cursor Rules

## ESO Lua Version Compatibility

**CRITICAL: ESO uses Lua 5.1, which has important limitations:**

- **NO `goto` statements**: The `goto` statement was introduced in Lua 5.2. ESO uses Lua 5.1, so `goto` and labels (`::label::`) will cause syntax errors.
  - **Solution**: Use `if-else` blocks or `continue`-like patterns instead of `goto continue`
  - **Example**: Instead of `goto continue`, wrap the processing logic in an `else` block or use early returns
  - **Error message**: If you see `= expected near 'continue'`, it means `goto` was used incorrectly

- **Other Lua 5.1 limitations to be aware of**:
  - No bitwise operators (use bit library if needed)
  - No `__pairs` and `__ipairs` metamethods
  - Some string functions may have different behavior

**Always test code in ESO's Lua 5.1 environment. Never use `goto` statements.**

---

## Project Structure & Patterns

### Namespace Convention
- All code must be in the `CharacterMarkdown` namespace (aliased as `CM`)
- Pattern: `local CM = CharacterMarkdown` at the top of each file
- Functions: `CM.moduleName.FunctionName()` or `CM.utils.FunctionName()`
- Never pollute global namespace

### Error Handling
- **Always use `CM.SafeCall()` for ESO API calls** (not `pcall` directly):
  ```lua
  -- CM.SafeCall automatically handles errors and returns nil on failure
  local result = CM.SafeCall(ESO_API_Function, args) or defaultValue
  ```
- **Use `pcall` only when you need multiple return values**:
  ```lua
  -- For functions that return multiple values, use pcall directly
  local success, value1, value2, value3 = pcall(GetMultipleValuesFunction, args)
  if not success then
      CM.DebugPrint("ERROR", "Function failed: " .. tostring(value1))
      return defaultValue1, defaultValue2, defaultValue3
  end
  ```
- **Note**: `CM.SafeCall` only returns the first return value. For multiple returns, use `pcall` directly.

### Debug & Logging
- Use the project's debug system, not direct `d()` calls:
  - `CM.DebugPrint(category, message)` - Silent unless LibDebugLogger enabled
  - `CM.Info(message)` - Always logged
  - `CM.Warn(message)` - Warning message
  - `CM.Error(message)` - Error shown in chat
- Never use `d()` directly - use `CM.Info()` or `CM.Error()` instead

### Performance Best Practices
- Cache global function lookups at module level:
  ```lua
  local string_format = string.format
  local table_insert = table.insert
  local string_gsub = string.gsub
  ```
- Use `table.concat()` for string building instead of concatenation
- Throttle event handlers when appropriate

### Module Organization
- **Collectors** (`src/collectors/`): Data gathering only, no formatting
- **Generators** (`src/generators/sections/`): Markdown creation only
- **Links** (`src/links/`): UESP URL generation only
- **Utils** (`src/utils/`): Reusable helper functions
- **Settings** (`src/settings/`): Use `CM.GetSettings()` to access, defaults in `CM.Settings.Defaults:GetAll()`
- **UI** (`src/ui/`): Window and display logic only

### Command Patterns
- **Subcommand Pattern**: Use colon notation `object:action_or_subobject` where the object comes first, then an action or subobject
  - Pattern: `command object:action` or `command object:subobject`
  - The main noun/object comes before the colon, the action/verb or subobject comes after
  - Examples:
    - `filter:clear` - perform **clear** action on **filter** object
    - `test:import-export` - test the **import-export** subsystem
    - `profile:save` - perform **save** action on **profile** object
  - **Action**: A verb that operates on the object (clear, save, delete, apply)
  - **Subobject**: A compound noun that further specifies the object (import-export, validation-report)
  - Always validate subcommands and show helpful error messages for unknown subcommands
- **Main Commands**:
  - `/markdown [format|test|unittest|filter:clear|help|save]`
  - `/cmdsettings [export|import|test:import-export]`
- **Format Commands**: Direct format names (github, vscode, discord, quick) without colons
- Always validate arguments and show helpful error messages

### Settings Management
- Access settings via `CM.GetSettings()` (handles defaults automatically)
- Defaults defined in `src/settings/Defaults.lua`
- Export/Import: Use `CM.utils.TableToYAML()` and `CM.utils.YAMLToTable()`
- Settings validation: Check against defaults, validate types

### File Structure
- Follow the load order in `CharacterMarkdown.addon` manifest
- Core → Utils → Links → Collectors → Generators → Commands → Events → Settings → UI → Init
- New modules must be added to manifest in correct order

### Testing
- Unit tests: `/markdown unittest` (collector tests)
- Validation tests: `/markdown test` (markdown validation)
- Export/Import tests: `/cmdsettings test:import-export`
- Test files in `src/utils/*Tests.lua`

### Chunking & Display
- Large markdown outputs are automatically chunked for EditBox limits (22k chars)
- Chunking handled in `src/utils/Chunking.lua`
- Window display in `src/ui/Window.lua` handles chunk navigation

### ESO API Guidelines
- Follow ESOUI best practices: https://wiki.esoui.com/
- Use ZO_SavedVars for settings persistence
- Use LibAddonMenu-2.0 for settings UI
- Use LibDebugLogger for debug output (optional dependency)

# CharacterMarkdown - Cursor Rules

## ESO Lua Version Compatibility

**CRITICAL: ESO uses Lua 5.1, which has important limitations:**

- **NO `goto` statements**: The `goto` statement was introduced in Lua 5.2. ESO uses Lua 5.1, so `goto` and labels (`::label::`) will cause syntax errors.
  - **Solution**: Use `if-else` blocks or `continue`-like patterns instead of `goto continue`
  - **Example**: Instead of `goto continue`, wrap the processing logic in an `else` block or use early returns
  - **Error message**: If you see `= expected near 'continue'`, it means `goto` was used incorrectly

- **Other Lua 5.1 limitations to be aware of**:
  - No bitwise operators (use bit library if needed)
  - No `__pairs` and `__ipairs` metamethods
  - Some string functions may have different behavior

**Always test code in ESO's Lua 5.1 environment. Never use `goto` statements.**

---

## Project Structure & Patterns

### Namespace Convention
- All code must be in the `CharacterMarkdown` namespace (aliased as `CM`)
- Pattern: `local CM = CharacterMarkdown` at the top of each file
- Functions: `CM.moduleName.FunctionName()` or `CM.utils.FunctionName()`
- Never pollute global namespace

### Error Handling
- **Always use `CM.SafeCall()` for ESO API calls** (not `pcall` directly):
  ```lua
  -- CM.SafeCall automatically handles errors and returns nil on failure
  local result = CM.SafeCall(ESO_API_Function, args) or defaultValue
  ```
- **Use `pcall` only when you need multiple return values**:
  ```lua
  -- For functions that return multiple values, use pcall directly
  local success, value1, value2, value3 = pcall(GetMultipleValuesFunction, args)
  if not success then
      CM.DebugPrint("ERROR", "Function failed: " .. tostring(value1))
      return defaultValue1, defaultValue2, defaultValue3
  end
  ```
- **Note**: `CM.SafeCall` only returns the first return value. For multiple returns, use `pcall` directly.

### Debug & Logging
- Use the project's debug system, not direct `d()` calls:
  - `CM.DebugPrint(category, message)` - Silent unless LibDebugLogger enabled
  - `CM.Info(message)` - Always logged
  - `CM.Warn(message)` - Warning message
  - `CM.Error(message)` - Error shown in chat
- Never use `d()` directly - use `CM.Info()` or `CM.Error()` instead

### Performance Best Practices
- Cache global function lookups at module level:
  ```lua
  local string_format = string.format
  local table_insert = table.insert
  local string_gsub = string.gsub
  ```
- Use `table.concat()` for string building instead of concatenation
- Throttle event handlers when appropriate
- Follow memory management best practices in `docs/MEMORY_MANAGEMENT.md`:
  - Clear large temporary data with `variable = nil` before returning
  - Unregister one-time event handlers immediately
  - Use `collectgarbage("step", 1000)` after large operations
  - Never cache collector data at module scope

### Module Organization
- **Collectors** (`src/collectors/`): Data gathering only, no formatting
- **Generators** (`src/generators/sections/`): Markdown creation only
- **Links** (`src/links/`): UESP URL generation only
- **Utils** (`src/utils/`): Reusable helper functions
- **Settings** (`src/settings/`): Use `CM.GetSettings()` to access, defaults in `CM.Settings.Defaults:GetAll()`
- **UI** (`src/ui/`): Window and display logic only

### Command Patterns
- **Subcommand Pattern**: Use colon notation `object:action_or_subobject` where the object comes first, then an action or subobject
  - Pattern: `command object:action` or `command object:subobject`
  - The main noun/object comes before the colon, the action/verb or subobject comes after
  - Examples:
    - `filter:clear` - perform **clear** action on **filter** object
    - `test:import-export` - test the **import-export** subsystem
    - `profile:save` - perform **save** action on **profile** object
  - **Action**: A verb that operates on the object (clear, save, delete, apply)
  - **Subobject**: A compound noun that further specifies the object (import-export, validation-report)
  - Always validate subcommands and show helpful error messages for unknown subcommands
- **Main Commands**:
  - `/markdown [format|test|unittest|filter:clear|help|save]`
  - `/cmdsettings [export|import|test:import-export]`
- **Format Commands**: Direct format names (github, vscode, discord, quick) without colons
- Always validate arguments and show helpful error messages

### Settings Management
- Access settings via `CM.GetSettings()` (handles defaults automatically)
- Defaults defined in `src/settings/Defaults.lua`
- Export/Import: Use `CM.utils.TableToYAML()` and `CM.utils.YAMLToTable()`
- Settings validation: Check against defaults, validate types

### SavedVariables Management

**Account-Wide Settings**: Use `ZO_SavedVars:NewAccountWide()` for all account-wide settings
- Stored in `CharacterMarkdownSettings`
- Initialized in `EVENT_ADD_ON_LOADED` handler
- Verify reference: `CM.settings` should equal `CharacterMarkdownSettings`

**Per-Character Data**: Store INSIDE account-wide settings (reliable approach)
- **Pattern**: Store per-character data in `CharacterMarkdownSettings.perCharacterData[characterId]`
- **Why**: Account-wide SavedVariables are more reliable than per-character SavedVariables
- **Implementation**:
  ```lua
  -- In InitializeCharacterData()
  local characterId = tostring(GetCurrentCharacterId())
  
  if not CM.settings.perCharacterData then
      CM.settings.perCharacterData = {}
  end
  
  if not CM.settings.perCharacterData[characterId] then
      CM.settings.perCharacterData[characterId] = {
          customNotes = "",
          customTitle = "",
          playStyle = "",
          _initialized = true,
          _lastModified = GetTimeStamp(),
      }
  end
  
  -- Point CM.charData to this character's data
  CM.charData = CM.settings.perCharacterData[characterId]
  ```

- **When adding new per-character fields**:
  1. Add to the initialization structure in `InitializeCharacterData()`
  2. Add to `src/settings/Defaults.lua` if it needs a default value
  3. No migration needed - changes are automatic when accessing `CM.charData`

- **Example of adding a field**:
  ```lua
  -- In InitializeCharacterData() initialization block
  if not CM.settings.perCharacterData[characterId] then
      CM.settings.perCharacterData[characterId] = {
          customNotes = "",
          customTitle = "",
          playStyle = "",
          newField = "",  -- Add here
          _initialized = true,
          _lastModified = GetTimeStamp(),
      }
  end
  ```

### File Structure
- Follow the load order in `CharacterMarkdown.addon` manifest
- Core â†’ Utils â†’ Links â†’ Collectors â†’ Generators â†’ Commands â†’ Events â†’ Settings â†’ UI â†’ Init
- New modules must be added to manifest in correct order

### File Naming Conventions
- **YAML files**: Always use `.yaml` suffix (not `.yml`)
  - Example: `config.yaml`, `book.toml` (TOML files use `.toml`)
  - This applies to all YAML configuration files, GitHub Actions workflows, etc.

### Testing
- Unit tests: `/markdown unittest` (collector tests)
- Validation tests: `/markdown test` (markdown validation)
- Export/Import tests: `/cmdsettings test:import-export`
- Test files in `src/utils/*Tests.lua`

### Chunking & Display
- Large markdown outputs are automatically chunked for EditBox limits (22k chars)
- Chunking handled in `src/utils/Chunking.lua`
- Window display in `src/ui/Window.lua` handles chunk navigation

### Settings Panel (LibAddonMenu-2.0)
- **NO emojis or Unicode icons in LAM settings**: LibAddonMenu-2.0 does not render emojis/icons properly
  - NEVER use emojis in checkbox names, section headers, or tooltips
  - NEVER use Unicode arrows (â†³, â””â”€, etc.) - they render as empty boxes
  - Use plain text and spaces only for all LAM UI elements
  - Example: Use "Combat & Build" not "ðŸŽ¯ Combat & Build"
- Organize settings by player intent and workflow, not arbitrary "core" vs "extended"
- Use plain spaces for indenting dependent/sub-options (4 spaces for first level, 8 for nested)
- Keep tooltips informative with character count estimates for large sections

### ESO API Guidelines
- Follow ESOUI best practices: https://wiki.esoui.com/
- Use ZO_SavedVars for settings persistence
- Use LibAddonMenu-2.0 for settings UI
- Use LibDebugLogger for debug output (optional dependency)

### Release Process
- **Before every release**: Run comprehensive pre-release validation using `RELEASE_CHECKLIST.md`
- **Automated checks**: Run `./scripts/pre-release-check.sh` or use `task test` and `task build`
- **Git hooks**: Optional pre-push hook available at `scripts/git-hooks/pre-push` to validate before pushing tags
- **Documentation**: See `docs/PUBLISHING.md` for detailed release process
- **Cursor AI**: Can automatically run validation checks from the release checklist

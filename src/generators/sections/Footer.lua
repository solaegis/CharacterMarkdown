-- CharacterMarkdown - Footer Section Generator
-- Generates markdown footer section

local CM = CharacterMarkdown

local markdown
local string_format = string.format

local function InitializeUtilities()
    if not markdown then
        markdown = CM.utils.markdown
    end
end

-- =====================================================
-- FOOTER
-- =====================================================

local function GenerateFooter(format, contentLength)
    InitializeUtilities()
    
    local enhanced = CM.settings and CM.settings.enableEnhancedVisuals
    
    if format == "quick" then return "" end
    
    -- Use ESO API for timestamp (os.date() is disabled in ESO Lua)
    local timestamp = ""
    local timeSuccess, timeStamp = pcall(GetTimeStamp)
    if timeSuccess and timeStamp then
        local dateSuccess, dateString = pcall(GetDateStringFromTimestamp, timeStamp)
        if dateSuccess and dateString then
            timestamp = dateString
        else
            timestamp = "unknown time"
        end
    else
        timestamp = "unknown time"
    end
    
    local formatNumber = CM.utils and CM.utils.FormatNumber
    local safeFormatNumber = function(val)
        if formatNumber then
            return formatNumber(val)
        else
            return tostring(val)
        end
    end
    
    if not enhanced or format == "discord" then
        -- Classic format
        return string.format([[

---

*Generated by CharacterMarkdown (%s) on %s*  
*Total size: ~%d characters*
]], format:upper(), timestamp, contentLength or 0)
    end
    
    -- ENHANCED: Use separator and attractive footer (only if markdown utilities are available)
    if not markdown then
        -- Fallback to classic if markdown utilities not loaded
        return string.format([[
---

*Generated by CharacterMarkdown (%s) on %s*  
*Total size: ~%s characters*
]], format:upper(), timestamp, safeFormatNumber(contentLength or 0))
    end
    
    -- Create attractive footer with badges and centered layout
    local formatBadge = markdown.CreateBadge("Format", format:upper(), "blue", "flat")
    local sizeBadge = markdown.CreateBadge("Size", safeFormatNumber(contentLength or 0) .. " chars", "purple", "flat")
    
    local badgeRow = string_format("%s %s", formatBadge, sizeBadge)
    
    local footerContent = string_format([[
<div align="center">

%s

**⚔️ CharacterMarkdown**

<sub>Generated on %s</sub>

</div>
]], badgeRow, timestamp)
    
    return "\n" .. (markdown.CreateSeparator("hr") or "") .. footerContent
end

-- =====================================================
-- EXPORTS
-- =====================================================

CM.generators.sections = CM.generators.sections or {}
CM.generators.sections.GenerateFooter = GenerateFooter

CM.DebugPrint("GENERATOR", "Footer section generator loaded (enhanced visuals)")
